<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GyattChores</title>
    <link rel="icon" type="image/svg+xml" href="gyattchores-logo-transparent.svg">
    <link rel="apple-touch-icon" href="gyattchores-logo-transparent.svg">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Google+Sans+Display:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            position: relative;
        }
        #root {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        input, textarea, button {
            font-family: 'Google Sans', sans-serif;
        }
        
        /* Apple-like Subtle Shadows */
        .elevation-1 {
            box-shadow: 0 1px 3px 0 rgba(0,0,0,.08), 0 1px 2px 0 rgba(0,0,0,.06);
        }
        .elevation-2 {
            box-shadow: 0 2px 8px 0 rgba(0,0,0,.1), 0 1px 4px 0 rgba(0,0,0,.08);
        }
        .elevation-3 {
            box-shadow: 0 4px 16px 0 rgba(0,0,0,.12), 0 2px 6px 0 rgba(0,0,0,.1);
        }
        
        /* Material Design Ripple Effect */
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .ripple:active:before {
            width: 300px;
            height: 300px;
            transition: 0s;
        }
        
        /* Smooth transitions */
        * {
            transition: background-color 0.2s cubic-bezier(0.4, 0.0, 0.2, 1),
                        color 0.2s cubic-bezier(0.4, 0.0, 0.2, 1),
                        box-shadow 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .dashboard-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 0 12px;
            width: 100%;
        }

        .dashboard-grid > div {
            flex: 1 1 300px;
            min-width: 0;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                flex-direction: column;
                gap: 8px;
                padding: 0 8px;
            }

            /* Reorder for mobile: Available Chores first, Players second, Pending third */
            .dashboard-grid > div:nth-child(1) { order: 2; }
            .dashboard-grid > div:nth-child(2) { order: 1; }
            .dashboard-grid > div:nth-child(3) { order: 3; }
        }
        
        .text-wrap {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* Floating Action Button */
        .fab {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border: none;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .fab:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px 0 rgba(0,0,0,.15);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Apple-style Card */
        .material-card {
            border-radius: 16px;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .material-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px 0 rgba(0,0,0,.12), 0 2px 6px 0 rgba(0,0,0,.1);
        }
        
        /* Chip Style */
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8125rem;
            font-weight: 500;
        }

        /* Input Apple Style */
        .material-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            box-sizing: border-box;
        }

        .material-input:focus {
            border-width: 2px;
            padding: 11px 15px;
        }

        /* Fix for date inputs on iOS */
        input[type="date"] {
            display: block;
            width: calc(100% - 32px) !important;
            max-width: calc(100% - 32px) !important;
            min-width: 0 !important;
            padding: 8px 12px !important;
            overflow: hidden;
            font-size: 0.875rem !important;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            flex-shrink: 0;
            margin-left: 4px;
            width: 16px;
            height: 16px;
        }

        input[type="date"]::-webkit-datetime-edit {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Button Apple Style */
        .material-button {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-size: 0.9375rem;
            font-weight: 500;
            letter-spacing: -0.01em;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            box-sizing: border-box;
        }

        .material-button:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px 0 rgba(0,0,0,.15);
        }

        .material-button:active {
            transform: scale(0.98);
        }
        
        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

        /* Achievement notification animation */
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Green glow animation for player bids */
        @keyframes greenGlow {
            0%, 100% {
                box-shadow: 0 0 8px rgba(76, 175, 80, 0.5), 0 0 16px rgba(76, 175, 80, 0.3), 0 2px 8px 0 rgba(0,0,0,.1);
            }
            50% {
                box-shadow: 0 0 16px rgba(76, 175, 80, 0.8), 0 0 24px rgba(76, 175, 80, 0.5), 0 2px 8px 0 rgba(0,0,0,.1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        .player-bid-glow {
            animation: greenGlow 2s ease-in-out infinite;
            border: 2px solid #4CAF50 !important;
        }

        /* Responsive Design for Mobile Devices */

        /* Small Phones (iPhone SE, iPhone 12 mini, etc.) */
        @media (max-width: 430px) {
            body {
                font-size: 14px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 0 12px;
            }

            .material-card {
                padding: 16px !important;
                margin-bottom: 8px !important;
            }

            /* Header adjustments */
            .fab {
                width: 44px;
                height: 44px;
                font-size: 16px;
            }

            /* Reduce massive tablet-sized fonts for phones */
            h1 {
                font-size: 1.25rem !important;
            }

            /* Player cards - scale down from tablet size */
            div[style*="fontSize: '1.75rem'"] {
                font-size: 1rem !important;
            }

            div[style*="fontSize: '3.5rem'"] {
                font-size: 2rem !important;
            }

            /* Chore items - scale down */
            div[style*="fontSize: '1.375rem'"] {
                font-size: 0.875rem !important;
            }

            div[style*="fontSize: '2.25rem'"] {
                font-size: 1.25rem !important;
            }

            /* Buttons - make more reasonable size */
            .material-button {
                padding: 10px 16px !important;
                font-size: 0.875rem !important;
            }

            button[style*="fontSize: '1.125rem'"] {
                font-size: 0.875rem !important;
                padding: 10px 14px !important;
            }

            /* Chips and badges */
            .chip {
                font-size: 0.7rem !important;
                padding: 3px 8px !important;
            }

            /* Touch targets should still be big enough */
            button {
                min-height: 44px;
                box-sizing: border-box;
            }

            /* Ensure all buttons respect width constraints */
            .material-button,
            button {
                max-width: 100%;
            }

            /* Player name truncation on mobile */
            div[style*="fontSize: '1.75rem'"] {
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
            }

            /* Ensure all text content respects container width */
            .material-card > * {
                max-width: 100%;
                overflow-wrap: break-word;
            }

            /* Chore card adjustments for mobile */
            div[style*="padding: '20px'"] {
                padding: 14px !important;
            }

            /* Ensure chore name displays properly */
            div[style*="fontSize: '1.125rem'"] {
                font-size: 0.9375rem !important;
            }
        }

        /* Standard Phones (iPhone 15 Pro, iPhone 16, etc.) */
        @media (min-width: 431px) and (max-width: 768px) {
            body {
                font-size: 15px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 0 16px;
            }

            .material-card {
                padding: 20px !important;
                margin-bottom: 10px !important;
            }

            .fab {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }

            /* Scale down tablet fonts for phone */
            h1 {
                font-size: 1.5rem !important;
            }

            /* Player names */
            div[style*="fontSize: '1.75rem'"] {
                font-size: 1.125rem !important;
            }

            /* Player avatars */
            div[style*="fontSize: '3.5rem'"] {
                font-size: 2.5rem !important;
            }

            /* Chore names */
            div[style*="fontSize: '1.375rem'"] {
                font-size: 1rem !important;
            }

            /* Chore icons */
            div[style*="fontSize: '2.25rem'"] {
                font-size: 1.5rem !important;
            }

            /* Buttons */
            .material-button {
                padding: 12px 18px !important;
                font-size: 1rem !important;
            }

            button[style*="fontSize: '1.125rem'"] {
                font-size: 1rem !important;
                padding: 12px 16px !important;
            }

            .chip {
                font-size: 0.75rem !important;
            }

            button {
                min-height: 44px;
                box-sizing: border-box;
            }

            /* Ensure all buttons respect width constraints */
            .material-button,
            button {
                max-width: 100%;
            }

            /* Text truncation for longer content */
            div[style*="fontSize: '1.75rem'"],
            div[style*="fontSize: '1.375rem'"] {
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
            }
        }

        /* iPads in Portrait (iPad 5th gen, iPad Air, etc.) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 18px;
                padding: 0 18px;
            }

            .material-card {
                padding: 24px !important;
            }

            .fab {
                width: 46px;
                height: 46px;
            }

            /* Slightly reduce tablet fonts for iPad */
            h1 {
                font-size: 1.75rem !important;
            }

            div[style*="fontSize: '1.75rem'"] {
                font-size: 1.5rem !important;
            }

            div[style*="fontSize: '3.5rem'"] {
                font-size: 3rem !important;
            }

            div[style*="fontSize: '1.375rem'"] {
                font-size: 1.25rem !important;
            }

            div[style*="fontSize: '2.25rem'"] {
                font-size: 2rem !important;
            }

            button[style*="fontSize: '1.125rem'"] {
                font-size: 1.0625rem !important;
            }
        }

        /* Wall-mounted tablets and desktop (1024px+) - Keep current large sizes */
        @media (min-width: 1025px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 20px;
                padding: 0 20px;
                width: 100%;
            }

            /* Current large sizes are perfect for wall-mounted displays */
        }

        /* Landscape phone adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            .material-card {
                padding: 12px !important;
                margin-bottom: 8px !important;
            }

            h1 {
                font-size: 1.125rem !important;
            }

            .fab {
                width: 44px;
                height: 44px;
                font-size: 14px;
            }

            button {
                min-height: 44px;
            }
        }

        /* Safe area padding for modern iPhones (notch/Dynamic Island) */
        @supports (padding: max(0px)) {
            body {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Ensure all containers respect viewport width */
        .dashboard-grid,
        .material-card,
        div[style*="width"],
        div[style*="maxWidth"] {
            max-width: 100% !important;
        }

        /* Keyboard focus indicators for accessibility */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 3px solid #1a73e8;
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Improve input font size on mobile to prevent zoom */
        @media (max-width: 768px) {
            input, textarea, select {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initialize Supabase
        const supabase = window.supabase.createClient(
            'https://ukshxdoqgwoxobjdclpx.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrc2h4ZG9xZ3dveG9iamRjbHB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjI2NDEsImV4cCI6MjA4MDI5ODY0MX0.UGNrsfG6goEA0PPWG4x7gxBueA7D5Oe9uWI-iCXIar0'
        );

        const LOGIN_PASSWORD = "0413";
        const APPROVAL_CODE = "7874";

        // Daily motivational quotes from kid-friendly characters
        const MOTIVATIONAL_QUOTES = [
            { quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { quote: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
            { quote: "Do or do not. There is no try.", author: "Yoda" },
            { quote: "It always seems impossible until it's done.", author: "Nelson Mandela" },
            { quote: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
            { quote: "You're braver than you believe, stronger than you seem, and smarter than you think.", author: "Christopher Robin" },
            { quote: "All our dreams can come true, if we have the courage to pursue them.", author: "Walt Disney" },
            { quote: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
            { quote: "Why do we fall? So we can learn to pick ourselves back up.", author: "Batman" },
            { quote: "With great power comes great responsibility.", author: "Spider-Man" },
            { quote: "Even miracles take a little time.", author: "Fairy Godmother" },
            { quote: "The flower that blooms in adversity is the most rare and beautiful of all.", author: "The Emperor (Mulan)" },
            { quote: "Just keep swimming!", author: "Dory" },
            { quote: "Adventure is out there!", author: "Ellie (Up)" },
            { quote: "To infinity and beyond!", author: "Buzz Lightyear" },
            { quote: "Ohana means family, and family means nobody gets left behind.", author: "Stitch" },
            { quote: "The past can hurt, but you can either run from it or learn from it.", author: "Rafiki" },
            { quote: "No matter how your heart is grieving, if you keep on believing, the dream that you wish will come true.", author: "Cinderella" },
            { quote: "Sometimes the right path is not the easiest one.", author: "Grandmother Willow" },
            { quote: "It's kind of fun to do the impossible.", author: "Walt Disney" },
            { quote: "A person's a person, no matter how small.", author: "Dr. Seuss" },
            { quote: "Don't cry because it's over, smile because it happened.", author: "Dr. Seuss" },
            { quote: "Today you are You, that is truer than true. There is no one alive who is Youer than You.", author: "Dr. Seuss" },
            { quote: "You have brains in your head. You have feet in your shoes. You can steer yourself any direction you choose.", author: "Dr. Seuss" },
            { quote: "The more that you read, the more things you will know. The more that you learn, the more places you'll go.", author: "Dr. Seuss" },
            { quote: "Nothing is impossible. The word itself says 'I'm possible!'", author: "Audrey Hepburn" },
            { quote: "A champion is someone who gets up when they can't.", author: "Jack Dempsey" },
            { quote: "Winning isn't everything, but wanting to win is.", author: "Vince Lombardi" },
            { quote: "The only limit to our realization of tomorrow will be our doubts of today.", author: "Franklin D. Roosevelt" },
            { quote: "Don't let what you cannot do interfere with what you can do.", author: "John Wooden" }
        ];

        // Get daily quote (same quote for everyone on the same day)
        const getDailyQuote = () => {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const dayOfYear = Math.max(0, Math.floor((now - start) / (1000 * 60 * 60 * 24)));
            const safeIndex = Math.floor(Math.abs(dayOfYear) % MOTIVATIONAL_QUOTES.length);
            return MOTIVATIONAL_QUOTES[safeIndex] || MOTIVATIONAL_QUOTES[0];
        };

        // Changelog - Updates and Bug Fixes
        const CHANGELOG = [
            {
                version: "2.8.0",
                date: "Dec 7, 2024",
                time: "11:30 PM MT",
                type: "feature",
                changes: [
                    "ðŸ“Š Simplified Admin Panel - Combined logs into tabbed interface",
                    "ðŸ”’ Error Logs & ðŸ“ Activity Logs now in single System Logs section",
                    "âœï¸ Enhanced Recent Completions with inline editing",
                    "ðŸ” Added filters: player, status, date range",
                    "ðŸ’¾ Edit chore type and date directly in completion list",
                    "Saved ~190 lines of code by eliminating duplication"
                ]
            },
            {
                version: "2.7.0",
                date: "Dec 7, 2024",
                time: "10:00 PM MT",
                type: "fix",
                changes: [
                    "ðŸ Fixed GOAT display: Current Week Leader vs Last Week Winner",
                    "ðŸ† Purple border for current week leader (still competing)",
                    "ðŸ¥‡ Gold border for GOAT of the Week (last week's winner)",
                    "ðŸ”§ Fixed week calculation to include Sunday in current week",
                    "âœ… Week resets at midnight Sunday/Monday",
                    "ðŸ› ï¸ Fixed toLocaleString errors with defensive type checking",
                    "ðŸ” Fixed Supabase search_path security warnings"
                ]
            },
            {
                version: "2.6.0",
                date: "Dec 7, 2024",
                time: "12:00 PM MT",
                type: "feature",
                changes: [
                    "ðŸ’š Redesigned Custom Task system with player emoji selection",
                    "Create custom tasks from dashboard with 'All' or individual player buttons",
                    "Custom tasks glow green in both the form and Available Chores list",
                    "Custom tasks automatically appear at the top of Available Chores",
                    "Tasks available to all players when 'All' is selected",
                    "Player-specific tasks when individual players are selected",
                    "Moved custom task creation to dashboard bottom for easy access"
                ]
            },
            {
                version: "2.5.0",
                date: "Dec 7, 2024",
                type: "feature",
                changes: [
                    "ðŸ’š Unified Custom Task Menu - Players and admins use the same green glowing form",
                    "Players use their code to submit task bids for admin review",
                    "Admins use their code to create tasks instantly",
                    "Added animated green glow to all custom task interactions",
                    "Player-specific task assignments - tasks only visible to assigned player",
                    "Admin bid management - accept, counter-offer, or reject player bids",
                    "Counter-offer negotiation flow between players and admins"
                ]
            },
            {
                version: "2.4.0",
                date: "Dec 7, 2024",
                type: "feature",
                changes: [
                    "ðŸ” Login required on each page load for enhanced security",
                    "ðŸ“‹ Changelog display on login screen showing latest updates",
                    "Removed session persistence for better privacy"
                ]
            },
            {
                version: "2.3.0",
                date: "Dec 6, 2024",
                type: "feature",
                changes: [
                    "ðŸŽ¯ Single-claim chores - certain tasks can only be done once per cooldown period",
                    "Added emojis to dog feeding chores for better visual appeal",
                    "Enhanced chore availability system with per-player cooldowns"
                ]
            },
            {
                version: "2.2.0",
                date: "Dec 5, 2024",
                type: "feature",
                changes: [
                    "ðŸ“Š Enhanced admin panel with error logging and security monitoring",
                    "ðŸ”’ Admin activity tracking for name/avatar changes",
                    "ðŸ“ Recent completions view in admin panel (last 30 days)",
                    "ðŸ¾ Pet feeding cooldowns to prevent over-claiming"
                ]
            },
            {
                version: "2.1.0",
                date: "Dec 4, 2024",
                type: "feature",
                changes: [
                    "ðŸ“ˆ Tiered payout system based on weekly performance",
                    "ðŸŽ® Leveling system with Option A and Option B progression paths",
                    "ðŸ“ Chore descriptions with 'Definition of Done' guidelines",
                    "âœ¨ Improved task clarity for players"
                ]
            },
            {
                version: "2.0.0",
                date: "Dec 3, 2024",
                type: "feature",
                changes: [
                    "ðŸ† Achievement system with multiple categories",
                    "ðŸŽ–ï¸ Milestone achievements for chores and points",
                    "â­ Weekly performance achievements",
                    "ðŸ”¥ Streak tracking and rewards",
                    "ðŸŒŸ Special achievements for unique accomplishments"
                ]
            },
            {
                version: "1.5.0",
                date: "Dec 2, 2024",
                type: "improvement",
                changes: [
                    "ðŸŽ¨ Improved mobile responsiveness",
                    "ðŸŒ“ Auto dark mode based on time of day (6 AM - 6 PM)",
                    "âœ¨ Material Design UI enhancements",
                    "ðŸ“± Better touch interactions and haptic feedback"
                ]
            }
        ];

        const getLastFridayOfMonth = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const lastDay = new Date(year, month + 1, 0);
            
            while (lastDay.getDay() !== 5) {
                lastDay.setDate(lastDay.getDate() - 1);
            }
            
            return lastDay.toLocaleDateString('en-US', { 
                month: 'long', 
                day: 'numeric',
                year: 'numeric'
            });
        };

        function FamilyChores() {
            // Auto-detect dark mode based on time of day in Mountain Time (6 AM - 6 PM = light, else dark)
            const getInitialDarkMode = () => {
                // Get current time in Mountain Time (America/Denver)
                const mountainTime = new Date().toLocaleString("en-US", {timeZone: "America/Denver"});
                const hour = new Date(mountainTime).getHours();
                return hour < 6 || hour >= 18;
            };

            // Temporarily allow session persistence for testing
            const [isLoggedIn, setIsLoggedIn] = useState(() => {
                return localStorage.getItem('gyatt_session') === 'active';
            });
            const [darkMode, setDarkMode] = useState(getInitialDarkMode);
            const [loading, setLoading] = useState(true);
            const [players, setPlayers] = useState([]);
            const [chores, setChores] = useState([]);
            const [pendingChores, setPendingChores] = useState([]);
            const [allCompletions, setAllCompletions] = useState([]);
            const [availableTasks, setAvailableTasks] = useState([]);

            const [newTaskName, setNewTaskName] = useState('');
            const [newTaskPoints, setNewTaskPoints] = useState('');
            const [newTaskDueDate, setNewTaskDueDate] = useState('');
            const [approvalCode, setApprovalCode] = useState('');
            const [showApproval, setShowApproval] = useState(null);

            // GOAT System states
            const [weeklyGoats, setWeeklyGoats] = useState([]);
            const [lastWeekGoat, setLastWeekGoat] = useState(null);

            // Weekly Reset states
            const [currentWeekStart, setCurrentWeekStart] = useState(null);
            const [needsWeeklyReset, setNeedsWeeklyReset] = useState(false);

            // Profile page states
            const [showProfile, setShowProfile] = useState(false);
            const [selectedPlayer, setSelectedPlayer] = useState(null);
            const [playerHistory, setPlayerHistory] = useState([]);

            // Monthly view states
            const [showMonthlyView, setShowMonthlyView] = useState(false);
            const [monthlyChores, setMonthlyChores] = useState([]);

            // Admin menu states
            const [showAdminMenu, setShowAdminMenu] = useState(false);
            const [editingChore, setEditingChore] = useState(null);
            const [errorLogs, setErrorLogs] = useState([]);
            const [errorStats, setErrorStats] = useState([]);
            const [activityLogs, setActivityLogs] = useState([]);
            const [approvedChores, setApprovedChores] = useState([]);
            const [editChoreFilter, setEditChoreFilter] = useState({ playerId: '', startDate: '', endDate: '', status: '' });
            const [activeLogTab, setActiveLogTab] = useState('errors'); // 'errors' or 'activity'

            // Bonus system states
            const [playerBonuses, setPlayerBonuses] = useState({});

            // Weather states
            const [weather, setWeather] = useState(null);
            const [weatherLoading, setWeatherLoading] = useState(true);

            // Achievement system states
            const [achievements, setAchievements] = useState([]);
            const [playerAchievements, setPlayerAchievements] = useState({});
            const [playerStats, setPlayerStats] = useState({});
            const [newAchievements, setNewAchievements] = useState([]);

            // Chore description states
            const [expandedChoreId, setExpandedChoreId] = useState(null);

            // Chore bidding states
            const [choreBids, setChoreBids] = useState([]);
            const [showBidForm, setShowBidForm] = useState(false);
            const [bidChoreName, setBidChoreName] = useState('');
            const [bidPoints, setBidPoints] = useState('');
            const [bidDueDate, setBidDueDate] = useState('');
            const [selectedBidPlayerId, setSelectedBidPlayerId] = useState(null);

            // Custom task form states (dashboard)
            const [customTaskName, setCustomTaskName] = useState('');
            const [customTaskPoints, setCustomTaskPoints] = useState('');
            const [customTaskDueDate, setCustomTaskDueDate] = useState('');
            const [selectedCustomTaskPlayers, setSelectedCustomTaskPlayers] = useState([]);

            // Pull to refresh states
            const [isPulling, setIsPulling] = useState(false);
            const [pullDistance, setPullDistance] = useState(0);
            const [refreshing, setRefreshing] = useState(false);

            // Login states
            const [loginPassword, setLoginPassword] = useState('');
            const [loginError, setLoginError] = useState('');

            // Login handler (no session persistence - forces login each time)
            const handleLogin = async (e) => {
                e.preventDefault();
                if (loginPassword === LOGIN_PASSWORD) {
                    setIsLoggedIn(true);
                    setLoginError('');
                } else {
                    setLoginError('Invalid password');
                    setLoginPassword('');
                    haptic('error');
                    // Log failed login attempt
                    await logError('login_failed', 'Incorrect password entered', loginPassword);
                }
            };

            // Logout handler
            const handleLogout = () => {
                setIsLoggedIn(false);
                setSelectedPlayer(null);
                setShowProfile(false);
                setShowAdminMenu(false);
            };

            // Haptic feedback utility
            const haptic = (type = 'light') => {
                if (!navigator.vibrate) return;

                const patterns = {
                    light: 10,
                    medium: 20,
                    heavy: 30,
                    success: [10, 50, 10],
                    error: [30, 100, 30],
                    click: 5
                };

                navigator.vibrate(patterns[type] || 10);
            };

            // Pull to refresh handler
            const handleRefresh = async () => {
                setRefreshing(true);
                haptic('medium');

                try {
                    await loadData();
                    await loadAllCompletions();
                    haptic('success');
                } catch (error) {
                    console.error('Refresh error:', error);
                    haptic('error');
                }

                setTimeout(() => {
                    setRefreshing(false);
                    setPullDistance(0);
                }, 500);
            };

            // Pull to refresh touch handlers
            useEffect(() => {
                let startY = 0;
                let scrollTop = 0;

                const handleTouchStart = (e) => {
                    scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    startY = e.touches[0].pageY;
                };

                const handleTouchMove = (e) => {
                    if (scrollTop > 5) return; // Only work when at top

                    const currentY = e.touches[0].pageY;
                    const distance = currentY - startY;

                    if (distance > 0 && distance < 150) {
                        setIsPulling(true);
                        setPullDistance(distance);
                        if (distance > 10) {
                            haptic('light');
                        }
                    }
                };

                const handleTouchEnd = () => {
                    if (pullDistance > 80) {
                        handleRefresh();
                    } else {
                        setPullDistance(0);
                    }
                    setIsPulling(false);
                };

                document.addEventListener('touchstart', handleTouchStart);
                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);

                return () => {
                    document.removeEventListener('touchstart', handleTouchStart);
                    document.removeEventListener('touchmove', handleTouchMove);
                    document.removeEventListener('touchend', handleTouchEnd);
                };
            }, [pullDistance]);

            // Session timeout - auto logout after 30 minutes of inactivity
            useEffect(() => {
                if (!isLoggedIn) return;

                const sessionTimeout = 30 * 60 * 1000; // 30 minutes
                const timer = setTimeout(() => {
                    handleLogout();
                    haptic('medium');
                    alert('â±ï¸ Session expired due to inactivity. Please log in again.');
                }, sessionTimeout);

                return () => clearTimeout(timer);
            }, [isLoggedIn]);

            // Load data from Supabase
            useEffect(() => {
                const checkAndReset = async () => {
                    await loadData();

                    // If reset is needed, trigger it automatically
                    if (needsWeeklyReset) {
                        await performWeeklyReset();
                    }
                };

                checkAndReset();
            }, []);

            // Auto-refresh for wall-mounted display - refresh every 15 minutes
            useEffect(() => {
                const interval = setInterval(() => {
                    console.log('Auto-refreshing data for wall display...');
                    loadData();
                }, 900000); // 15 minutes

                return () => clearInterval(interval);
            }, []);

            const loadData = async () => {
                try {
                    setLoading(true);

                    // Check current week and if reset is needed
                    const monday = new Date();
                    const dayOfWeek = monday.getDay();
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    monday.setDate(monday.getDate() + daysToMonday);
                    monday.setHours(0, 0, 0, 0);
                    const weekStartDate = monday.toISOString().split('T')[0];

                    // Check if we've already reset this week
                    try {
                        const { data: resetData, error: resetError } = await supabase
                            .from('weekly_resets')
                            .select('*')
                            .eq('week_start_date', weekStartDate)
                            .maybeSingle();

                        // If error (like 406), table might not exist - skip weekly reset check
                        if (!resetError) {
                            // If no reset record for this week exists, we need to reset
                            if (!resetData) {
                                setNeedsWeeklyReset(true);
                                setCurrentWeekStart(weekStartDate);
                            }
                        }
                    } catch (err) {
                        // Silently handle weekly_resets table not existing
                        console.log('Weekly resets table not available:', err);
                    }

                    // Load players
                    const { data: playersData, error: playersError } = await supabase
                        .from('players')
                        .select('*')
                        .order('name');

                    if (playersError) throw playersError;

                    // Load chores
                    const { data: choresData, error: choresError } = await supabase
                        .from('chores')
                        .select('*')
                        .eq('is_active', true)
                        .order('name');

                    if (choresError) throw choresError;

                    // Load pending chore completions
                    const { data: pendingData, error: pendingError } = await supabase
                        .from('chore_completions')
                        .select(`
                            *,
                            players(name),
                            chores(name, icon)
                        `)
                        .eq('status', 'pending')
                        .order('completed_at', { ascending: false });

                    if (pendingError) throw pendingError;

                    // Load all APPROVED and PENDING completions from past 7 days for cooldown checking
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const { data: allCompletionsData } = await supabase
                        .from('chore_completions')
                        .select('chore_id, completed_at, player_id')
                        .in('status', ['approved', 'pending'])
                        .gte('completed_at', sevenDaysAgo.toISOString())
                        .order('completed_at', { ascending: false });

                    // Get weekly totals for each player
                    const playersWithStats = await Promise.all(playersData.map(async (player) => {
                        const { count } = await supabase
                            .from('chore_completions')
                            .select('*', { count: 'exact', head: true })
                            .eq('player_id', player.id)
                            .eq('status', 'approved');

                        // Get current week's points
                        const monday = new Date();
                        const dayOfWeek = monday.getDay();
                        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        monday.setDate(monday.getDate() + daysToMonday);
                        monday.setHours(0, 0, 0, 0);
                        const weekStartDate = monday.toISOString().split('T')[0];

                        const { data: weeklyData } = await supabase
                            .from('chore_completions')
                            .select('value_awarded')
                            .eq('player_id', player.id)
                            .eq('status', 'approved')
                            .gte('completed_date', weekStartDate);

                        const chorePoints = weeklyData?.reduce((sum, c) => sum + c.value_awarded, 0) || 0;

                        // Get current week's bonuses
                        const { data: bonusData } = await supabase
                            .from('bonuses')
                            .select('bonus_amount')
                            .eq('player_id', player.id)
                            .eq('week_start_date', weekStartDate);

                        const bonusPoints = bonusData?.reduce((sum, b) => sum + b.bonus_amount, 0) || 0;

                        return {
                            id: player.id,
                            name: player.name,
                            avatar: player.avatar_url,
                            points: chorePoints + bonusPoints,
                            completedChores: count || 0,
                            best_week_total: player.best_week_total
                        };
                    }));

                    // Format chores
                    const formattedChores = choresData.map(chore => ({
                        id: chore.id,
                        name: chore.name,
                        points: chore.base_value,
                        icon: chore.icon,
                        max_per_day: chore.max_per_day,
                        description: chore.description,
                        cooldown_hours: chore.cooldown_hours || 24,
                        single_claim: chore.single_claim || false,
                        assigned_player_id: chore.assigned_player_id || null,
                        is_from_bid: chore.is_from_bid || false
                    }));

                    // Format pending chores
                    const formattedPending = pendingData.map(completion => ({
                        id: completion.id,
                        playerId: completion.player_id,
                        choreId: completion.chore_id,
                        choreName: completion.chores?.name || 'Unknown Chore',
                        points: completion.value_awarded,
                        icon: completion.chores?.icon || 'â“',
                        status: 'pending',
                        timestamp: new Date(completion.completed_at)
                    }));

                    setPlayers(playersWithStats);
                    setChores(formattedChores);
                    setPendingChores(formattedPending);
                    setAllCompletions(allCompletionsData || []);

                    // Get current week's GOAT(s)
                    const { data: goatData, error: goatError } = await supabase
                        .rpc('get_weekly_goat');

                    if (goatError) {
                        console.error('Error fetching weekly GOAT:', goatError);
                    }
                    console.log('Weekly GOAT data:', goatData);
                    setWeeklyGoats(goatData || []);

                    // Load achievements data
                    const { data: achievementsData } = await supabase
                        .from('achievements')
                        .select('*')
                        .order('requirement_value', { ascending: true });

                    const { data: playerAchievementsData } = await supabase
                        .from('player_achievements')
                        .select('*');

                    const { data: playerStatsData } = await supabase
                        .from('player_stats')
                        .select('*');

                    setAchievements(achievementsData || []);

                    // Group player achievements by player_id
                    const achievementsByPlayer = {};
                    (playerAchievementsData || []).forEach(pa => {
                        if (!achievementsByPlayer[pa.player_id]) {
                            achievementsByPlayer[pa.player_id] = [];
                        }
                        achievementsByPlayer[pa.player_id].push(pa);
                    });
                    setPlayerAchievements(achievementsByPlayer);

                    // Group player stats by player_id
                    const statsByPlayer = {};
                    (playerStatsData || []).forEach(ps => {
                        statsByPlayer[ps.player_id] = ps;
                    });
                    setPlayerStats(statsByPlayer);

                    // Get last week's GOAT for display
                    const lastMonday = new Date(monday);
                    lastMonday.setDate(lastMonday.getDate() - 7);

                    const { data: prevWeekData } = await supabase
                        .rpc('get_weekly_totals', {
                            week_start: lastMonday.toISOString().split('T')[0]
                        });

                    if (prevWeekData && prevWeekData.length > 0) {
                        const maxTotal = Math.max(...prevWeekData.map(p => p.weekly_total));
                        const lastWeekWinners = prevWeekData.filter(p => p.weekly_total === maxTotal && maxTotal > 0);
                        setLastWeekGoat(lastWeekWinners.length > 0 ? lastWeekWinners : null);
                    }

                    // Load chore bids
                    const { data: bidsData } = await supabase
                        .from('chore_bids')
                        .select('*, players(name, avatar_url)')
                        .order('created_at', { ascending: false });

                    setChoreBids(bidsData || []);

                } catch (error) {
                    console.error('Error loading data:', error);
                    haptic('error');
                    alert(`Error loading data: ${error.message || 'Unknown error'}`);
                } finally {
                    setLoading(false);
                }
            };

            // Call bonus checker after loading data
            useEffect(() => {
                if (!loading && players.length > 0) {
                    checkAndAwardBonuses();
                }
            }, [players, loading]);

            // Fetch weather on mount
            useEffect(() => {
                fetchWeather();
            }, []);

            // Material Design with Brand Colors
            const darkTheme = {
                bg: '#0D121A',
                surface: '#1F1F1F',
                surfaceVariant: '#363845',
                text: '#E8EAED',
                textSecondary: '#9AA0A6',
                primary: '#47B2C4',
                primaryVariant: '#3498B0',
                secondary: '#F23861',
                secondaryVariant: '#D91F4A',
                tertiary: '#B59ED9',
                error: '#F28B82',
                success: '#81C995',
                cardBg: '#1E1E1E',
                cardText: '#E8EAED',
                onPrimary: '#000000',
                outline: '#5F6368',
                accent: '#120ACC'
            };

            const lightTheme = {
                bg: '#F6F0E0',
                surface: '#FFFFFF',
                surfaceVariant: '#F6F0E0',
                text: '#1B1714',
                textSecondary: '#5F6368',
                primary: '#D0A500',
                primaryVariant: '#B89300',
                secondary: '#F85D00',
                secondaryVariant: '#E04F00',
                tertiary: '#EB701E',
                error: '#B3261E',
                success: '#0F9D58',
                cardBg: '#FFFFFF',
                cardText: '#1B1714',
                onPrimary: '#FFFFFF',
                outline: '#79747E',
                accent: '#EB701E'
            };

            // Memoize theme to prevent unnecessary re-renders
            const theme = React.useMemo(() =>
                darkMode ? darkTheme : lightTheme,
                [darkMode]
            );

            // Helper function to check if player is GOAT (last week's winner)
            const isGoat = (playerId) => {
                return lastWeekGoat && lastWeekGoat.some(goat => goat.player_id === playerId);
            };

            // Check and award bonuses
            const checkAndAwardBonuses = async () => {
                try {
                    const monday = new Date();
                    const dayOfWeek = monday.getDay();
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    monday.setDate(monday.getDate() + daysToMonday);
                    monday.setHours(0, 0, 0, 0);
                    const weekStartDate = monday.toISOString().split('T')[0];

                    // Get last week's GOAT total
                    const lastMonday = new Date(monday);
                    lastMonday.setDate(lastMonday.getDate() - 7);

                    const { data: lastWeekTotals } = await supabase
                        .rpc('get_weekly_totals', {
                            week_start: lastMonday.toISOString().split('T')[0]
                        });

                    const lastWeekGoatTotal = lastWeekTotals && lastWeekTotals.length > 0
                        ? Math.max(...lastWeekTotals.map(p => p.weekly_total))
                        : 0;

                    // Check bonuses for each player
                    for (const player of players) {
                        // Check Beat Last Week's GOAT bonus (ðŸ”¥)
                        if (lastWeekGoatTotal > 0 && player.points > lastWeekGoatTotal) {
                            // Check if bonus already awarded this week
                            const { data: existing } = await supabase
                                .from('bonuses')
                                .select('*')
                                .eq('player_id', player.id)
                                .eq('week_start_date', weekStartDate)
                                .eq('bonus_type', 'beat_goat')
                                .single();

                            if (!existing) {
                                const bonusAmount = 500; // 500 point bonus
                                await supabase
                                    .from('bonuses')
                                    .insert([{
                                        player_id: player.id,
                                        week_start_date: weekStartDate,
                                        bonus_type: 'beat_goat',
                                        bonus_amount: bonusAmount
                                    }]);
                                console.log(`ðŸ”¥ Beat GOAT bonus awarded to ${player.name}!`);
                            }
                        }

                        // Check Beat Personal Best bonus (ðŸš€)
                        if (player.best_week_total > 0 && player.points > player.best_week_total) {
                            // Check if bonus already awarded this week
                            const { data: existing } = await supabase
                                .from('bonuses')
                                .select('*')
                                .eq('player_id', player.id)
                                .eq('week_start_date', weekStartDate)
                                .eq('bonus_type', 'beat_personal_best')
                                .single();

                            if (!existing) {
                                const bonusAmount = 750; // 750 point bonus
                                await supabase
                                    .from('bonuses')
                                    .insert([{
                                        player_id: player.id,
                                        week_start_date: weekStartDate,
                                        bonus_type: 'beat_personal_best',
                                        bonus_amount: bonusAmount
                                    }]);

                                // Update personal best
                                await supabase
                                    .from('players')
                                    .update({ best_week_total: player.points })
                                    .eq('id', player.id);

                                console.log(`ðŸš€ Personal Best bonus awarded to ${player.name}!`);
                            }
                        }
                    }

                    // Load current week's bonuses for display
                    const { data: bonuses } = await supabase
                        .from('bonuses')
                        .select('*')
                        .eq('week_start_date', weekStartDate);

                    const bonusMap = {};
                    bonuses?.forEach(bonus => {
                        if (!bonusMap[bonus.player_id]) {
                            bonusMap[bonus.player_id] = [];
                        }
                        bonusMap[bonus.player_id].push(bonus);
                    });
                    setPlayerBonuses(bonusMap);

                } catch (error) {
                    console.error('Error checking bonuses:', error);
                }
            };

            // Check and award achievements
            const checkAndAwardAchievements = async (playerId) => {
                try {
                    // Get current player stats
                    const { data: stats } = await supabase
                        .from('player_stats')
                        .select('*')
                        .eq('player_id', playerId)
                        .single();

                    if (!stats) return;

                    // Get player's current achievements
                    const { data: earnedAchievements } = await supabase
                        .from('player_achievements')
                        .select('achievement_id')
                        .eq('player_id', playerId);

                    const earnedIds = new Set(earnedAchievements?.map(a => a.achievement_id) || []);

                    // Check each achievement
                    const newlyEarned = [];
                    for (const achievement of achievements) {
                        // Skip if already earned
                        if (earnedIds.has(achievement.id)) continue;

                        let earned = false;

                        switch (achievement.requirement_type) {
                            case 'total_chores':
                                earned = stats.total_chores_completed >= achievement.requirement_value;
                                break;
                            case 'total_points':
                                earned = stats.total_points_earned >= achievement.requirement_value;
                                break;
                            case 'goat_wins':
                                earned = stats.goat_wins >= achievement.requirement_value;
                                break;
                            case 'streak_days':
                                earned = stats.current_streak >= achievement.requirement_value ||
                                         stats.longest_streak >= achievement.requirement_value;
                                break;
                            case 'special':
                                if (achievement.name === 'Early Bird') {
                                    earned = stats.early_bird_count >= achievement.requirement_value;
                                } else if (achievement.name === 'Night Owl') {
                                    earned = stats.night_owl_count >= achievement.requirement_value;
                                } else if (achievement.name === 'Overachiever') {
                                    earned = stats.personal_best_beats >= achievement.requirement_value;
                                }
                                break;
                        }

                        if (earned) {
                            // Award the achievement
                            await supabase
                                .from('player_achievements')
                                .insert([{
                                    player_id: playerId,
                                    achievement_id: achievement.id
                                }]);

                            newlyEarned.push(achievement);
                        }
                    }

                    // Show notifications for newly earned achievements
                    if (newlyEarned.length > 0) {
                        setNewAchievements(prev => [...prev, ...newlyEarned.map(a => ({
                            ...a,
                            playerId
                        }))]);

                        // Auto-dismiss after 5 seconds
                        setTimeout(() => {
                            setNewAchievements(prev => prev.filter(na =>
                                !newlyEarned.some(ne => ne.id === na.id && na.playerId === playerId)
                            ));
                        }, 5000);

                        // Reload data to show new achievements
                        await loadData();
                    }
                } catch (error) {
                    console.error('Error checking achievements:', error);
                }
            };

            // TODO: FUTURE FEATURE - Streak Multiplier System
            // Implement this function to calculate point multipliers based on streak
            // const calculateStreakMultiplier = (currentStreak) => {
            //     if (currentStreak >= 14) return 1.5;  // 14+ days: 1.5x points
            //     if (currentStreak >= 7) return 1.25;  // 7-13 days: 1.25x points
            //     if (currentStreak >= 3) return 1.1;   // 3-6 days: 1.1x points
            //     return 1.0; // No bonus
            // };

            // Update player stats when chore is completed
            const updatePlayerStats = async (playerId, choreCompletedAt, pointsAwarded) => {
                try {
                    const { data: stats } = await supabase
                        .from('player_stats')
                        .select('*')
                        .eq('player_id', playerId)
                        .single();

                    const completedDate = new Date(choreCompletedAt).toISOString().split('T')[0];
                    const completedHour = new Date(choreCompletedAt).getHours();
                    const today = new Date().toISOString().split('T')[0];

                    // Calculate streak (TODO: Use this for multiplier when implementing feature above)
                    let newStreak = 1;
                    if (stats.last_activity_date) {
                        const lastDate = new Date(stats.last_activity_date);
                        const currentDate = new Date(completedDate);
                        const daysDiff = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));

                        if (daysDiff === 1) {
                            // Consecutive day
                            newStreak = (stats.current_streak || 0) + 1;
                        } else if (daysDiff === 0) {
                            // Same day
                            newStreak = stats.current_streak || 1;
                        }
                        // If daysDiff > 1, streak breaks, reset to 1
                    }

                    // Update stats
                    await supabase
                        .from('player_stats')
                        .update({
                            total_chores_completed: (stats.total_chores_completed || 0) + 1,
                            total_points_earned: (stats.total_points_earned || 0) + pointsAwarded,
                            current_streak: newStreak,
                            longest_streak: Math.max(stats.longest_streak || 0, newStreak),
                            last_activity_date: completedDate,
                            early_bird_count: completedHour < 12 ? (stats.early_bird_count || 0) + 1 : stats.early_bird_count,
                            night_owl_count: completedHour >= 18 ? (stats.night_owl_count || 0) + 1 : stats.night_owl_count,
                            updated_at: new Date().toISOString()
                        })
                        .eq('player_id', playerId);

                    // Check for Speed Demon achievement (5 chores in one day)
                    const { data: todayCompletions } = await supabase
                        .from('chore_completions')
                        .select('id')
                        .eq('player_id', playerId)
                        .eq('completed_date', today)
                        .eq('status', 'approved');

                    if (todayCompletions && todayCompletions.length >= 5) {
                        // Mark Speed Demon progress
                        await checkAndAwardAchievements(playerId);
                    }

                    // Check for achievements
                    await checkAndAwardAchievements(playerId);
                } catch (error) {
                    console.error('Error updating player stats:', error);
                }
            };

            // Fetch weather for Brighton, CO
            const fetchWeather = async () => {
                try {
                    // Check cache (localStorage with 30-min expiry)
                    const cached = localStorage.getItem('weather_cache');
                    if (cached) {
                        const { data, timestamp } = JSON.parse(cached);
                        const age = Date.now() - timestamp;
                        if (age < 30 * 60 * 1000) { // 30 minutes
                            setWeather(data);
                            setWeatherLoading(false);
                            return;
                        }
                    }

                    // Brighton, CO location
                    const location = 'Brighton,Colorado';

                    // Using free wttr.in API (no key required)
                    const url = `https://wttr.in/${location}?format=j1`;

                    // Add timeout to prevent hanging
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

                    try {
                        const response = await fetch(url, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        const data = await response.json();

                    // Validate weather data structure
                    if (!data.current_condition || !data.current_condition[0]) {
                        throw new Error('Invalid weather data structure');
                    }

                    const currentCondition = data.current_condition[0];

                    if (!currentCondition.weatherDesc || !currentCondition.weatherDesc[0]) {
                        throw new Error('Invalid weather description data');
                    }

                    const tempF = Math.round(parseFloat(currentCondition.temp_F));
                    const description = currentCondition.weatherDesc[0].value;

                    // Weather icon mapping based on weather codes
                    const getWeatherIcon = (desc) => {
                        const lower = desc.toLowerCase();
                        if (lower.includes('sunny') || lower.includes('clear')) return 'â˜€ï¸';
                        if (lower.includes('cloud')) return 'â˜ï¸';
                        if (lower.includes('rain')) return 'ðŸŒ§ï¸';
                        if (lower.includes('snow')) return 'â„ï¸';
                        if (lower.includes('storm') || lower.includes('thunder')) return 'â›ˆï¸';
                        if (lower.includes('drizzle') || lower.includes('mist')) return 'ðŸŒ¦ï¸';
                        if (lower.includes('fog')) return 'ðŸŒ«ï¸';
                        return 'ðŸŒ¤ï¸';
                    };

                    // Clothing suggestions based on temp
                    let clothing = '';
                    if (tempF < 32) clothing = 'Heavy coat, hat, and gloves!';
                    else if (tempF < 50) clothing = 'Jacket or sweater recommended';
                    else if (tempF < 65) clothing = 'Light jacket might be nice';
                    else if (tempF < 80) clothing = 'Perfect weather, dress comfortably!';
                    else clothing = 'Stay cool, light clothing!';

                    // Get tomorrow's forecast
                    let tomorrowForecast = null;
                    if (data.weather && data.weather[1]) {
                        const tomorrow = data.weather[1];
                        const tomorrowMaxF = Math.round(parseFloat(tomorrow.maxtempF));
                        const tomorrowMinF = Math.round(parseFloat(tomorrow.mintempF));
                        const tomorrowDesc = tomorrow.hourly?.[4]?.weatherDesc?.[0]?.value || 'Conditions vary';

                        tomorrowForecast = {
                            maxTemp: tomorrowMaxF,
                            minTemp: tomorrowMinF,
                            description: tomorrowDesc,
                            icon: getWeatherIcon(tomorrowDesc)
                        };
                    }

                    const weatherData = {
                        temp: tempF,
                        description: description,
                        icon: getWeatherIcon(description),
                        clothing,
                        tomorrow: tomorrowForecast
                    };

                    // Cache for 30 minutes
                    try {
                        localStorage.setItem('weather_cache', JSON.stringify({
                            data: weatherData,
                            timestamp: Date.now()
                        }));
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            console.warn('localStorage quota exceeded, clearing weather cache');
                            localStorage.removeItem('weather_cache');
                        }
                    }

                    setWeather(weatherData);
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        throw fetchError;
                    }
                } catch (error) {
                    console.error('Error fetching weather:', error.name === 'AbortError' ? 'Weather API timeout' : error);
                    // Fallback data
                    setWeather({
                        temp: '--',
                        condition: 'Weather unavailable',
                        icon: 'ðŸŒ¤ï¸',
                        clothing: 'Check outside before heading out!'
                    });
                } finally {
                    setWeatherLoading(false);
                }
            };

            // Load player profile data
            const loadPlayerProfile = async (playerId) => {
                try {
                    // Get last 30 days of chore history
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                    const { data, error } = await supabase
                        .from('chore_completions')
                        .select(`
                            *,
                            chores(name, icon, base_value)
                        `)
                        .eq('player_id', playerId)
                        .gte('completed_date', thirtyDaysAgo.toISOString().split('T')[0])
                        .order('completed_date', { ascending: false });

                    if (error) throw error;

                    setPlayerHistory(data || []);
                } catch (error) {
                    console.error('Error loading player profile:', error);
                }
            };

            // Load monthly chores for all players
            const loadMonthlyChores = async () => {
                try {
                    // Get first day of current month
                    const now = new Date();
                    const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const firstDayStr = firstDayOfMonth.toISOString().split('T')[0];

                    const { data, error } = await supabase
                        .from('chore_completions')
                        .select(`
                            *,
                            chores(name, icon),
                            players(name, avatar_url)
                        `)
                        .eq('status', 'approved')
                        .gte('completed_date', firstDayStr)
                        .order('completed_date', { ascending: false });

                    if (error) throw error;

                    setMonthlyChores(data || []);
                } catch (error) {
                    console.error('Error loading monthly chores:', error);
                }
            };

            // Weekly reset function
            const performWeeklyReset = async () => {
                try {
                    // Record the reset
                    await supabase
                        .from('weekly_resets')
                        .insert([{
                            week_start_date: currentWeekStart
                        }]);

                    setNeedsWeeklyReset(false);
                    await loadAllCompletions();
                    await loadData(); // Refresh data

                    console.log('Weekly reset completed for week starting:', currentWeekStart);
                } catch (error) {
                    console.error('Error performing weekly reset:', error);
                }
            };

            // Load all completions for admin menu
            const loadAllCompletions = async () => {
                try {
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                    const { data, error } = await supabase
                        .from('chore_completions')
                        .select(`
                            *,
                            chores(name, icon),
                            players(name, avatar_url)
                        `)
                        .gte('completed_date', thirtyDaysAgo.toISOString().split('T')[0])
                        .order('completed_date', { ascending: false });

                    if (error) throw error;
                    setAllCompletions(data || []);
                } catch (error) {
                    console.error('Error loading completions:', error);
                }
            };

            // Load error logs for admin panel
            const loadErrorLogs = async () => {
                try {
                    // Get recent error logs
                    const { data: logs, error: logsError } = await supabase
                        .rpc('get_recent_error_logs', { limit_count: 50 });

                    if (logsError) throw logsError;
                    setErrorLogs(logs || []);

                    // Get error statistics
                    const { data: stats, error: statsError } = await supabase
                        .rpc('get_error_stats');

                    if (statsError) throw statsError;
                    setErrorStats(stats || []);
                } catch (error) {
                    console.error('Error loading error logs:', error);
                }
            };

            // Load admin activity logs
            const loadActivityLogs = async () => {
                try {
                    const { data: logs, error } = await supabase
                        .rpc('get_recent_admin_logs', { limit_count: 50 });

                    if (error) throw error;
                    setActivityLogs(logs || []);
                } catch (error) {
                    console.error('Error loading activity logs:', error);
                }
            };

            // Update chore completion date
            const updateChoreDate = async (completionId, newDate) => {
                try {
                    const { error } = await supabase
                        .from('chore_completions')
                        .update({ completed_date: newDate })
                        .eq('id', completionId);

                    if (error) throw error;

                    haptic('success');
                    alert('âœ… Chore date updated!');
                    await loadAllCompletions();
                    await loadData();
                } catch (error) {
                    console.error('Error updating chore date:', error);
                    haptic('error');
                    alert(`Error updating date: ${error.message || 'Unknown error'}`);
                }
            };

            // Add backfill chore entry
            const addBackfillChore = async (playerId, choreId, date, points) => {
                try {
                    // Fetch player and chore details for logging
                    const player = players.find(p => p.id === playerId);
                    const chore = chores.find(c => c.id === choreId);

                    if (!player || !chore) {
                        throw new Error('Player or chore not found');
                    }

                    // Insert the backfill entry
                    const { error } = await supabase
                        .from('chore_completions')
                        .insert([{
                            player_id: playerId,
                            chore_id: choreId,
                            completed_date: date,
                            value_awarded: points,
                            status: 'approved' // Auto-approve backfilled entries
                            // Note: completed_at will be set by database default
                        }]);

                    if (error) throw error;

                    // Update player stats
                    await updatePlayerStats(playerId, date, points);

                    // Log to admin activity logs
                    await supabase
                        .from('admin_activity_logs')
                        .insert([{
                            activity_type: 'backfill_entry',
                            player_id: playerId,
                            old_value: null,
                            new_value: `${chore.name} - ${points} pts`,
                            description: `Backfill entry added for ${player.name}: ${chore.name} (${points} pts) on ${date}`
                        }]);

                    // Reload all data to ensure everything is in sync BEFORE showing alert
                    await loadAllCompletions();
                    await loadData();
                    await loadMonthlyChores();

                    // Refresh player profile if currently viewing any player
                    if (showProfile && selectedPlayer) {
                        await loadPlayerProfile(selectedPlayer.id);
                    }

                    // Show success AFTER all data is reloaded
                    haptic('success');
                    alert('âœ… Backfill entry added!');
                } catch (error) {
                    console.error('Error adding backfill:', error);

                    // Log error to console (could be extended to error_logs table if needed)
                    await supabase
                        .from('admin_activity_logs')
                        .insert([{
                            activity_type: 'other',
                            player_id: playerId,
                            old_value: null,
                            new_value: null,
                            description: `ERROR: Failed to add backfill entry - ${error.message || 'Unknown error'}`
                        }])
                        .catch(logError => console.error('Failed to log error:', logError));

                    haptic('error');
                    alert(`Error adding backfill: ${error.message || 'Unknown error'}`);
                }
            };

            // Load approved chores for editing
            const loadApprovedChores = async (playerId = '', startDate = '', endDate = '') => {
                try {
                    let query = supabase
                        .from('chore_completions')
                        .select(`
                            *,
                            players(name),
                            chores(name, icon, base_value)
                        `)
                        .eq('status', 'approved')
                        .order('completed_date', { ascending: false })
                        .limit(100);

                    if (playerId) {
                        query = query.eq('player_id', playerId);
                    }
                    if (startDate) {
                        query = query.gte('completed_date', startDate);
                    }
                    if (endDate) {
                        query = query.lte('completed_date', endDate);
                    }

                    const { data, error } = await query;
                    if (error) throw error;
                    setApprovedChores(data || []);
                } catch (error) {
                    console.error('Error loading approved chores:', error);
                    alert(`Error loading chores: ${error.message}`);
                }
            };

            // Edit approved chore
            const editApprovedChore = async (completionId, newChoreId, newDate) => {
                try {
                    // Get the completion details
                    const { data: completion, error: fetchError } = await supabase
                        .from('chore_completions')
                        .select('*, players(name), chores(name)')
                        .eq('id', completionId)
                        .single();

                    if (fetchError) throw fetchError;

                    // Get new chore details
                    const newChore = chores.find(c => c.id === newChoreId);
                    if (!newChore) throw new Error('New chore not found');

                    // Update the completion
                    const { error: updateError } = await supabase
                        .from('chore_completions')
                        .update({
                            chore_id: newChoreId,
                            completed_date: newDate,
                            value_awarded: newChore.points
                        })
                        .eq('id', completionId);

                    if (updateError) throw updateError;

                    // Log the change
                    await supabase
                        .from('admin_activity_logs')
                        .insert([{
                            activity_type: 'edit_completion',
                            player_id: completion.player_id,
                            old_value: `${completion.chores.name} on ${completion.completed_date}`,
                            new_value: `${newChore.name} on ${newDate}`,
                            description: `Edited ${completion.players.name}'s completion from "${completion.chores.name}" (${completion.completed_date}) to "${newChore.name}" (${newDate})`
                        }]);

                    haptic('success');
                    alert('âœ… Chore updated successfully!');

                    // Reload data
                    await loadApprovedChores(editChoreFilter.playerId, editChoreFilter.startDate, editChoreFilter.endDate);
                    await loadData();
                } catch (error) {
                    console.error('Error editing chore:', error);
                    haptic('error');
                    alert(`Error: ${error.message}`);
                }
            };

            // Calculate tiered payout (Option B)
            const calculateTieredPayout = (weeklyPoints, payoutTier = 'B') => {
                if (payoutTier !== 'B') {
                    // Option C will be implemented later
                    return { total: 0, breakdown: [] };
                }

                let payout = 0;
                const breakdown = [];

                // Tier 1: First 500 points at $0.01 per point (max $5.00)
                const tier1Points = Math.min(weeklyPoints, 500);
                if (tier1Points > 0) {
                    const tier1Payout = tier1Points * 0.01;
                    payout += tier1Payout;
                    breakdown.push({
                        tier: 1,
                        points: tier1Points,
                        rate: '$0.01/pt',
                        amount: tier1Payout
                    });
                }

                // Tier 2: Points 501-1000 at $0.008 per point (max $4.00)
                if (weeklyPoints > 500) {
                    const tier2Points = Math.min(weeklyPoints - 500, 500);
                    const tier2Payout = tier2Points * 0.008;
                    payout += tier2Payout;
                    breakdown.push({
                        tier: 2,
                        points: tier2Points,
                        rate: '$0.008/pt',
                        amount: tier2Payout
                    });
                }

                // Tier 3: Points 1000+ at $0.005 per point (no cap)
                if (weeklyPoints > 1000) {
                    const tier3Points = weeklyPoints - 1000;
                    const tier3Payout = tier3Points * 0.005;
                    payout += tier3Payout;
                    breakdown.push({
                        tier: 3,
                        points: tier3Points,
                        rate: '$0.005/pt',
                        amount: tier3Payout
                    });
                }

                return {
                    total: Math.round(payout * 100) / 100, // Round to 2 decimals
                    breakdown
                };
            };

            // Capture device and browser information
            const getDeviceInfo = () => {
                return {
                    browser: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    screenWidth: window.screen.width,
                    screenHeight: window.screen.height,
                    viewport: {
                        width: window.innerWidth,
                        height: window.innerHeight
                    },
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timestamp: new Date().toISOString()
                };
            };

            // Log error to database
            const logError = async (errorType, errorMessage, userInput = null) => {
                try {
                    const deviceInfo = getDeviceInfo();

                    await supabase
                        .from('error_logs')
                        .insert({
                            error_type: errorType,
                            error_message: errorMessage,
                            user_input: userInput,
                            device_info: deviceInfo,
                            ip_address: null, // Will be captured by Supabase
                            user_agent: navigator.userAgent
                        });
                } catch (err) {
                    // Silent fail - don't show error to user
                    console.error('Error logging failed:', err);
                }
            };

            // Check if chore is available based on cooldown and player assignment
            const getChoreAvailability = (chore, playerId = null) => {
                // If chore is assigned to a specific player, only that player can see it
                if (chore.assigned_player_id && playerId && chore.assigned_player_id !== playerId) {
                    return { available: false, hoursRemaining: 0, playerSpecific: true };
                }

                // Special case: "Take Trash to Curb" is always available on Sundays
                const now = new Date();
                const isSunday = now.getDay() === 0;
                if (chore.name === 'Take Trash to Curb' && isSunday) {
                    return { available: true, hoursRemaining: 0 };
                }

                // Find the most recent completion of this chore
                // For single-claim chores (e.g., Feed Alfred), check if ANY player has done it
                // For shared chores (e.g., Wash Dishes), check if THIS player has done it
                const lastCompletion = (chore.single_claim || !playerId)
                    ? allCompletions.find(c => c.chore_id === chore.id)
                    : allCompletions.find(c => c.chore_id === chore.id && c.player_id === playerId);

                if (!lastCompletion) {
                    return { available: true, hoursRemaining: 0 };
                }

                const lastCompletedAt = new Date(lastCompletion.completed_at);
                const hoursSinceCompletion = (now - lastCompletedAt) / (1000 * 60 * 60);
                const cooldownHours = chore.cooldown_hours || 24;

                if (hoursSinceCompletion >= cooldownHours) {
                    return { available: true, hoursRemaining: 0 };
                }

                const hoursRemaining = Math.ceil(cooldownHours - hoursSinceCompletion);
                return { available: false, hoursRemaining };
            };

            const resetCooldowns = () => {
                if (confirm('Reset all chore cooldowns? This will make all chores available again for all players.')) {
                    setAllCompletions([]);
                    haptic('success');
                    alert('âœ… All cooldowns have been reset! All chores are now available.');
                }
            };

            const claimChore = async (playerId, chore) => {
                try {
                    // Check cooldown first (per-player cooldown)
                    const availability = getChoreAvailability(chore, playerId);
                    if (!availability.available) {
                        const days = Math.floor(availability.hoursRemaining / 24);
                        const hours = availability.hoursRemaining % 24;
                        let timeText = '';
                        if (days > 0) {
                            timeText = days === 1 ? '1 day' : `${days} days`;
                            if (hours > 0) timeText += ` ${hours}h`;
                        } else {
                            timeText = hours === 1 ? '1 hour' : `${hours} hours`;
                        }
                        haptic('error');
                        alert(`â³ This chore is on cooldown! Available in ${timeText}.`);
                        return;
                    }

                    // Check if player already did this chore today
                    const today = new Date().toISOString().split('T')[0];
                    const { data: existing } = await supabase
                        .from('chore_completions')
                        .select('*')
                        .eq('player_id', playerId)
                        .eq('chore_id', chore.id)
                        .eq('completed_date', today);

                    if (existing && existing.length > 0) {
                        haptic('error');
                        alert('âš ï¸ This chore was already done today!');
                        return;
                    }

                    // High-value chores (>500 pts) can't be done more than once every 3 days
                    // Exception: "Clean Room" can be done daily per player
                    if (chore.points > 500 && chore.name !== 'Clean Room') {
                        const threeDaysAgo = new Date();
                        threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                        const threeDaysAgoStr = threeDaysAgo.toISOString().split('T')[0];

                        const { data: recentHigh } = await supabase
                            .from('chore_completions')
                            .select('completed_date')
                            .eq('player_id', playerId)
                            .eq('chore_id', chore.id)
                            .gte('completed_date', threeDaysAgoStr)
                            .order('completed_date', { ascending: false })
                            .limit(1);

                        if (recentHigh && recentHigh.length > 0) {
                            const lastDate = new Date(recentHigh[0].completed_date);
                            const daysSince = Math.floor((new Date(today) - lastDate) / (1000 * 60 * 60 * 24));
                            const daysRemaining = 3 - daysSince;
                            haptic('error');
                            alert(`âš ï¸ High-value chore! You must wait ${daysRemaining} more day${daysRemaining === 1 ? '' : 's'} before doing this again.`);
                            return;
                        }
                    }

                    // Insert chore completion
                    // TODO: Add streak multiplier here in the future
                    // Example: const multiplier = calculateStreakMultiplier(currentStreak);
                    // const pointsWithBonus = chore.points * multiplier;
                    const { data, error } = await supabase
                        .from('chore_completions')
                        .insert([{
                            player_id: playerId,
                            chore_id: chore.id,
                            completed_date: today,
                            value_awarded: chore.points, // TODO: Apply streak multiplier
                            status: 'pending'
                        }])
                        .select(`
                            *,
                            players(name),
                            chores(name, icon)
                        `)
                        .single();

                    if (error) throw error;

                    // Add to local pending state
                    setPendingChores(prev => [...prev, {
                        id: data.id,
                        playerId: data.player_id,
                        choreId: data.chore_id,
                        choreName: data.chores?.name || 'Unknown Chore',
                        points: data.value_awarded,
                        icon: data.chores?.icon || 'â“',
                        status: 'pending',
                        timestamp: new Date(data.completed_at)
                    }]);

                    // Add to allCompletions immediately for cooldown tracking
                    setAllCompletions(prev => [{
                        chore_id: data.chore_id,
                        completed_at: data.completed_at,
                        player_id: data.player_id
                    }, ...prev]);

                    haptic('success');
                    alert(`âœ… Chore claimed! Waiting for approval.`);
                } catch (error) {
                    console.error('Error claiming chore:', error);
                    haptic('error');
                    alert(`Error claiming chore: ${error.message || 'Unknown error'}`);
                }
            };


            const approveChore = async (choreId, code) => {
                if (code !== APPROVAL_CODE) {
                    haptic('error');
                    alert('âŒ Invalid admin code');
                    return;
                }

                try {
                    // Get chore details before updating
                    const { data: choreCompletion } = await supabase
                        .from('chore_completions')
                        .select('player_id, completed_at, value_awarded')
                        .eq('id', choreId)
                        .single();

                    // Update chore completion status to approved
                    const { error } = await supabase
                        .from('chore_completions')
                        .update({ status: 'approved' })
                        .eq('id', choreId);

                    if (error) throw error;

                    // Update player stats and check achievements
                    if (choreCompletion) {
                        await updatePlayerStats(
                            choreCompletion.player_id,
                            choreCompletion.completed_at,
                            choreCompletion.value_awarded
                        );

                        // FIX: Immediately refresh player stats for this player to update streak display
                        const { data: freshStats } = await supabase
                            .from('player_stats')
                            .select('*')
                            .eq('player_id', choreCompletion.player_id)
                            .single();

                        if (freshStats) {
                            setPlayerStats(prev => ({
                                ...prev,
                                [choreCompletion.player_id]: freshStats
                            }));
                        }
                    }

                    // Remove from pending list
                    setPendingChores(prev => prev.filter(c => c.id !== choreId));
                    setShowApproval(null);
                    setApprovalCode('');

                    // Reload data to update points
                    await loadData();

                    // FIX: If viewing player profile, refresh their history for updated Last 7 Days
                    if (showProfile && selectedPlayer && choreCompletion.player_id === selectedPlayer.id) {
                        await loadPlayerProfile(selectedPlayer.id);
                    }

                    haptic('success');
                    alert('âœ… Chore approved!');
                } catch (error) {
                    console.error('Error approving chore:', error);
                    haptic('error');
                    alert(`Error approving chore: ${error.message || 'Unknown error'}`);
                }
            };

            const rejectChore = async (choreId) => {
                try {
                    // Update chore completion status to rejected
                    const { error } = await supabase
                        .from('chore_completions')
                        .update({ status: 'rejected' })
                        .eq('id', choreId);

                    if (error) throw error;

                    // Remove from pending list
                    setPendingChores(prev => prev.filter(c => c.id !== choreId));
                    setShowApproval(null);
                    setApprovalCode('');

                    haptic('medium');
                    alert('âŒ Chore rejected');
                } catch (error) {
                    console.error('Error rejecting chore:', error);
                    haptic('error');
                    alert(`Error rejecting chore: ${error.message || 'Unknown error'}`);
                }
            };

            const createTask = async () => {
                if (!newTaskName.trim() || newTaskPoints <= 0) {
                    haptic('error');
                    alert('Please enter a task name and point value');
                    return;
                }

                const code = prompt('Enter admin code to create custom task:');
                if (code !== APPROVAL_CODE) {
                    if (code !== null) {
                        haptic('error');
                        alert('âŒ Invalid admin code');
                    }
                    return;
                }

                try {
                    // Store due date in description as JSON
                    const description = newTaskDueDate ? JSON.stringify({ due_date: newTaskDueDate }) : null;

                    const { data, error } = await supabase
                        .from('chores')
                        .insert([{
                            name: newTaskName,
                            base_value: parseInt(newTaskPoints),
                            description: description,
                            icon: 'â­',
                            is_active: true,
                            max_per_day: 1
                        }])
                        .select()
                        .single();

                    if (error) throw error;

                    // Add to chores list
                    setChores(prev => [...prev, {
                        id: data.id,
                        name: data.name,
                        points: data.base_value,
                        icon: data.icon,
                        max_per_day: data.max_per_day,
                        description: data.description
                    }]);

                    setNewTaskName('');
                    setNewTaskPoints('');
                    setNewTaskDueDate('');
                    haptic('success');
                    alert('âœ… Custom task created!');
                } catch (error) {
                    console.error('Error creating task:', error);
                    haptic('error');
                    alert(`Error creating custom task: ${error.message || 'Unknown error'}`);
                }
            };

            // Submit a unified custom task (handles both player bids and admin direct creation)
            const submitUnifiedCustomTask = async () => {
                if (!selectedPlayer) {
                    haptic('error');
                    alert('Please select a player first');
                    return;
                }

                if (!bidChoreName.trim() || !bidPoints || bidPoints <= 0) {
                    haptic('error');
                    alert('Please enter a task name and point value');
                    return;
                }

                const code = prompt('Enter your code:\nâ€¢ Players: Use your code (submits bid for review)\nâ€¢ Admin: Use your admin code (creates task immediately)');

                if (code === null) {
                    return; // User cancelled
                }

                // Check if it's the player code
                if (code === '0413') {
                    // Player bid submission
                    try {
                        const { data, error } = await supabase
                            .from('chore_bids')
                            .insert([{
                                player_id: selectedPlayer.id,
                                chore_name: bidChoreName,
                                proposed_points: parseInt(bidPoints),
                                due_date: bidDueDate || null,
                                status: 'pending'
                            }])
                            .select('*, players(name, avatar_url)')
                            .single();

                        if (error) throw error;

                        setChoreBids(prev => [data, ...prev]);
                        setBidChoreName('');
                        setBidPoints('');
                        setBidDueDate('');
                        setShowBidForm(false);
                        haptic('success');
                        alert('âœ… Your custom task bid has been submitted! An admin will review it.');
                    } catch (error) {
                        console.error('Error submitting bid:', error);
                        haptic('error');
                        alert(`Error submitting bid: ${error.message || 'Unknown error'}`);
                    }
                } else if (code === APPROVAL_CODE) {
                    // Admin direct creation (assigned to selected player)
                    try {
                        const description = bidDueDate ? JSON.stringify({ due_date: bidDueDate }) : null;

                        const { data, error } = await supabase
                            .from('chores')
                            .insert([{
                                name: bidChoreName,
                                base_value: parseInt(bidPoints),
                                description: description,
                                icon: 'â­',
                                is_active: true,
                                max_per_day: 1,
                                assigned_player_id: selectedPlayer.id,
                                is_from_bid: false
                            }])
                            .select()
                            .single();

                        if (error) throw error;

                        // Add to chores list
                        setChores(prev => [...prev, {
                            id: data.id,
                            name: data.name,
                            points: data.base_value,
                            icon: data.icon,
                            max_per_day: data.max_per_day,
                            description: data.description,
                            assigned_player_id: data.assigned_player_id,
                            is_from_bid: false
                        }]);

                        setBidChoreName('');
                        setBidPoints('');
                        setBidDueDate('');
                        setShowBidForm(false);
                        haptic('success');
                        alert(`âœ… Custom task created and assigned to ${selectedPlayer.name}!`);
                    } catch (error) {
                        console.error('Error creating task:', error);
                        haptic('error');
                        alert(`Error creating custom task: ${error.message || 'Unknown error'}`);
                    }
                } else {
                    haptic('error');
                    alert('âŒ Invalid code');
                }
            };

            // Admin accepts a bid and creates the chore
            const acceptBid = async (bidId) => {
                const code = prompt('Enter admin code to accept this bid:');
                if (code !== APPROVAL_CODE) {
                    if (code !== null) {
                        haptic('error');
                        alert('âŒ Invalid admin code');
                    }
                    return;
                }

                try {
                    const bid = choreBids.find(b => b.id === bidId);
                    if (!bid) throw new Error('Bid not found');

                    // Use counter-offered points if available, otherwise use proposed points
                    const points = bid.admin_counter_points || bid.proposed_points;

                    // Create the chore with player assignment
                    const description = bid.due_date ? JSON.stringify({ due_date: bid.due_date }) : null;

                    const { data: choreData, error: choreError } = await supabase
                        .from('chores')
                        .insert([{
                            name: bid.chore_name,
                            base_value: points,
                            description: description,
                            icon: 'â­',
                            is_active: true,
                            max_per_day: 1,
                            assigned_player_id: bid.player_id,
                            is_from_bid: true
                        }])
                        .select()
                        .single();

                    if (choreError) throw choreError;

                    // Update bid status
                    const { error: bidError } = await supabase
                        .from('chore_bids')
                        .update({ status: 'accepted', updated_at: new Date().toISOString() })
                        .eq('id', bidId);

                    if (bidError) throw bidError;

                    // Add to chores list
                    setChores(prev => [...prev, {
                        id: choreData.id,
                        name: choreData.name,
                        points: choreData.base_value,
                        icon: choreData.icon,
                        max_per_day: choreData.max_per_day,
                        description: choreData.description,
                        assigned_player_id: choreData.assigned_player_id,
                        is_from_bid: true
                    }]);

                    // Update bid in state
                    setChoreBids(prev => prev.map(b =>
                        b.id === bidId ? { ...b, status: 'accepted' } : b
                    ));

                    haptic('success');
                    alert('âœ… Bid accepted! Custom task created.');
                } catch (error) {
                    console.error('Error accepting bid:', error);
                    haptic('error');
                    alert(`Error accepting bid: ${error.message || 'Unknown error'}`);
                }
            };

            // Admin proposes a counter bid
            const counterBid = async (bidId) => {
                const code = prompt('Enter admin code to counter-offer:');
                if (code !== APPROVAL_CODE) {
                    if (code !== null) {
                        haptic('error');
                        alert('âŒ Invalid admin code');
                    }
                    return;
                }

                const bid = choreBids.find(b => b.id === bidId);
                if (!bid) {
                    haptic('error');
                    alert('Bid not found');
                    return;
                }

                const counterPoints = prompt(`Current bid: ${bid.proposed_points} pts\nEnter your counter-offer (points):`);
                if (!counterPoints || isNaN(counterPoints) || counterPoints <= 0) {
                    if (counterPoints !== null) {
                        haptic('error');
                        alert('Invalid point value');
                    }
                    return;
                }

                const notes = prompt('Optional note to player:') || '';

                try {
                    const { error } = await supabase
                        .from('chore_bids')
                        .update({
                            status: 'counter_offered',
                            admin_counter_points: parseInt(counterPoints),
                            admin_notes: notes,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', bidId);

                    if (error) throw error;

                    // Update bid in state
                    setChoreBids(prev => prev.map(b =>
                        b.id === bidId
                            ? { ...b, status: 'counter_offered', admin_counter_points: parseInt(counterPoints), admin_notes: notes }
                            : b
                    ));

                    haptic('success');
                    alert('âœ… Counter-offer sent!');
                } catch (error) {
                    console.error('Error sending counter-offer:', error);
                    haptic('error');
                    alert(`Error: ${error.message || 'Unknown error'}`);
                }
            };

            // Player accepts admin's counter-offer
            const acceptCounterOffer = async (bidId) => {
                const code = prompt('Enter your player code to accept the counter-offer:');
                if (code !== '0413') {
                    if (code !== null) {
                        haptic('error');
                        alert('âŒ Invalid code');
                    }
                    return;
                }

                try {
                    const bid = choreBids.find(b => b.id === bidId);
                    if (!bid || !bid.admin_counter_points) {
                        throw new Error('Counter-offer not found');
                    }

                    // Create the chore with player assignment
                    const description = bid.due_date ? JSON.stringify({ due_date: bid.due_date }) : null;

                    const { data: choreData, error: choreError } = await supabase
                        .from('chores')
                        .insert([{
                            name: bid.chore_name,
                            base_value: bid.admin_counter_points,
                            description: description,
                            icon: 'â­',
                            is_active: true,
                            max_per_day: 1,
                            assigned_player_id: bid.player_id,
                            is_from_bid: true
                        }])
                        .select()
                        .single();

                    if (choreError) throw choreError;

                    // Update bid status
                    const { error: bidError } = await supabase
                        .from('chore_bids')
                        .update({ status: 'accepted', updated_at: new Date().toISOString() })
                        .eq('id', bidId);

                    if (bidError) throw bidError;

                    // Add to chores list
                    setChores(prev => [...prev, {
                        id: choreData.id,
                        name: choreData.name,
                        points: choreData.base_value,
                        icon: choreData.icon,
                        max_per_day: choreData.max_per_day,
                        description: choreData.description,
                        assigned_player_id: choreData.assigned_player_id,
                        is_from_bid: true
                    }]);

                    // Update bid in state
                    setChoreBids(prev => prev.map(b =>
                        b.id === bidId ? { ...b, status: 'accepted' } : b
                    ));

                    haptic('success');
                    alert('âœ… Counter-offer accepted! Your custom task is now available.');
                } catch (error) {
                    console.error('Error accepting counter-offer:', error);
                    haptic('error');
                    alert(`Error: ${error.message || 'Unknown error'}`);
                }
            };

            // Reject a bid
            const rejectBid = async (bidId) => {
                const code = prompt('Enter admin code to reject this bid:');
                if (code !== APPROVAL_CODE) {
                    if (code !== null) {
                        haptic('error');
                        alert('âŒ Invalid admin code');
                    }
                    return;
                }

                if (!confirm('Are you sure you want to reject this bid?')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('chore_bids')
                        .update({ status: 'rejected', updated_at: new Date().toISOString() })
                        .eq('id', bidId);

                    if (error) throw error;

                    setChoreBids(prev => prev.map(b =>
                        b.id === bidId ? { ...b, status: 'rejected' } : b
                    ));

                    haptic('success');
                    alert('Bid rejected');
                } catch (error) {
                    console.error('Error rejecting bid:', error);
                    haptic('error');
                    alert(`Error: ${error.message || 'Unknown error'}`);
                }
            };

            // Submit custom task from dashboard (supports multiple players or all)
            const submitDashboardCustomTask = async () => {
                if (!customTaskName.trim() || !customTaskPoints || customTaskPoints <= 0) {
                    haptic('error');
                    alert('Please enter a task name and point value');
                    return;
                }

                if (selectedCustomTaskPlayers.length === 0) {
                    haptic('error');
                    alert('Please select at least one player or "All"');
                    return;
                }

                const code = prompt('Enter your code:\nâ€¢ Players: Submit bid for review\nâ€¢ Admin: Create task immediately');

                if (code === null) {
                    return; // User cancelled
                }

                const isPlayerCode = code === '0413';
                const isAdminCode = code === APPROVAL_CODE;

                if (!isPlayerCode && !isAdminCode) {
                    haptic('error');
                    alert('âŒ Invalid code');
                    return;
                }

                // Determine which players this task is for
                const isAllPlayers = selectedCustomTaskPlayers.includes('all');
                const targetPlayers = isAllPlayers ? players : players.filter(p => selectedCustomTaskPlayers.includes(p.id));

                if (isPlayerCode) {
                    // Create bids for each selected player
                    try {
                        const bids = await Promise.all(
                            targetPlayers.map(async (player) => {
                                const { data, error } = await supabase
                                    .from('chore_bids')
                                    .insert([{
                                        player_id: player.id,
                                        chore_name: customTaskName,
                                        proposed_points: parseInt(customTaskPoints),
                                        due_date: customTaskDueDate || null,
                                        status: 'pending'
                                    }])
                                    .select('*, players(name, avatar_url)')
                                    .single();

                                if (error) throw error;
                                return data;
                            })
                        );

                        setChoreBids(prev => [...bids, ...prev]);
                        setCustomTaskName('');
                        setCustomTaskPoints('');
                        setCustomTaskDueDate('');
                        setSelectedCustomTaskPlayers([]);
                        haptic('success');
                        alert(`âœ… ${bids.length} task bid(s) submitted for admin review!`);
                    } catch (error) {
                        console.error('Error submitting bids:', error);
                        haptic('error');
                        alert(`Error submitting bids: ${error.message || 'Unknown error'}`);
                    }
                } else {
                    // Admin creates task(s) immediately
                    try {
                        const description = customTaskDueDate ? JSON.stringify({ due_date: customTaskDueDate }) : null;

                        if (isAllPlayers) {
                            // Create one task available to everyone (no assigned_player_id)
                            const { data, error } = await supabase
                                .from('chores')
                                .insert([{
                                    name: customTaskName,
                                    base_value: parseInt(customTaskPoints),
                                    description: description,
                                    icon: 'â­',
                                    is_active: true,
                                    max_per_day: 1,
                                    assigned_player_id: null,
                                    is_from_bid: false
                                }])
                                .select()
                                .single();

                            if (error) throw error;

                            setChores(prev => [...prev, {
                                id: data.id,
                                name: data.name,
                                points: data.base_value,
                                icon: data.icon,
                                max_per_day: data.max_per_day,
                                description: data.description,
                                assigned_player_id: null,
                                is_from_bid: false
                            }]);

                            haptic('success');
                            alert('âœ… Custom task created for all players!');
                        } else {
                            // Create separate task for each selected player
                            const tasks = await Promise.all(
                                targetPlayers.map(async (player) => {
                                    const { data, error } = await supabase
                                        .from('chores')
                                        .insert([{
                                            name: customTaskName,
                                            base_value: parseInt(customTaskPoints),
                                            description: description,
                                            icon: 'â­',
                                            is_active: true,
                                            max_per_day: 1,
                                            assigned_player_id: player.id,
                                            is_from_bid: false
                                        }])
                                        .select()
                                        .single();

                                    if (error) throw error;
                                    return {
                                        id: data.id,
                                        name: data.name,
                                        points: data.base_value,
                                        icon: data.icon,
                                        max_per_day: data.max_per_day,
                                        description: data.description,
                                        assigned_player_id: data.assigned_player_id,
                                        is_from_bid: false
                                    };
                                })
                            );

                            setChores(prev => [...prev, ...tasks]);
                            haptic('success');
                            alert(`âœ… ${tasks.length} custom task(s) created!`);
                        }

                        setCustomTaskName('');
                        setCustomTaskPoints('');
                        setCustomTaskDueDate('');
                        setSelectedCustomTaskPlayers([]);
                    } catch (error) {
                        console.error('Error creating tasks:', error);
                        haptic('error');
                        alert(`Error creating tasks: ${error.message || 'Unknown error'}`);
                    }
                }
            };

            // Toggle player selection for custom task
            const toggleCustomTaskPlayer = (playerId) => {
                if (playerId === 'all') {
                    setSelectedCustomTaskPlayers(prev =>
                        prev.includes('all') ? [] : ['all']
                    );
                } else {
                    setSelectedCustomTaskPlayers(prev => {
                        const filtered = prev.filter(id => id !== 'all');
                        if (filtered.includes(playerId)) {
                            return filtered.filter(id => id !== playerId);
                        } else {
                            return [...filtered, playerId];
                        }
                    });
                }
            };

            const payoutDate = getLastFridayOfMonth();

            if (loading) {
                return (
                    <div style={{
                        minHeight: '100vh',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        background: theme.bg,
                        color: theme.text,
                        fontSize: '1.5rem'
                    }}>
                        Loading...
                    </div>
                );
            }

            // Admin Menu View
            if (showAdminMenu) {
                return (
                    <div style={{
                        minHeight: '100vh',
                        background: theme.bg,
                        color: theme.text,
                        padding: '16px'
                    }}>
                        {/* Header with Back Button */}
                        <div className="elevation-2" style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '16px',
                            padding: '12px 20px',
                            marginBottom: '24px',
                            
                            margin: '0 auto 24px',
                            background: theme.surface,
                            borderRadius: '16px',
                            height: '56px'
                        }}>
                            <button
                                onClick={() => {
                                    setShowAdminMenu(false);
                                    setEditingChore(null);
                                }}
                                className="fab elevation-1 ripple"
                                style={{
                                    background: theme.primary,
                                    color: theme.onPrimary,
                                    width: '48px',
                                    height: '48px',
                                    fontSize: '1.25rem'
                                }}
                            >
                                â†
                            </button>
                            <h1 style={{
                                fontSize: '1.375rem',
                                fontWeight: '500',
                                margin: 0,
                                fontFamily: "'Google Sans Display', sans-serif"
                            }}>
                                âš™ï¸ Admin Panel
                            </h1>
                        </div>

                        <div style={{  margin: '0 auto' }}>
                            {/* Add Backfill Entry */}
                            <div className="material-card elevation-1" style={{
                                padding: '20px',
                                background: theme.cardBg,
                                marginBottom: '24px'
                            }}>
                                <h2 style={{
                                    fontSize: '1.125rem',
                                    fontWeight: '500',
                                    marginBottom: '16px',
                                    color: theme.cardText
                                }}>
                                    âž• Add Backfill Entry
                                </h2>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                    <select
                                        id="backfill-player"
                                        style={{
                                            padding: '12px',
                                            borderRadius: '8px',
                                            border: `1px solid ${theme.outline}`,
                                            background: theme.surface,
                                            color: theme.text,
                                            fontSize: '1rem'
                                        }}
                                    >
                                        <option value="">Select Player</option>
                                        {(players || []).map(player => (
                                            <option key={player.id} value={player.id}>
                                                {player.name}
                                            </option>
                                        ))}
                                    </select>
                                    <select
                                        id="backfill-chore"
                                        style={{
                                            padding: '12px',
                                            borderRadius: '8px',
                                            border: `1px solid ${theme.outline}`,
                                            background: theme.surface,
                                            color: theme.text,
                                            fontSize: '1rem'
                                        }}
                                    >
                                        <option value="">Select Chore</option>
                                        {chores.map(chore => (
                                            <option key={chore.id} value={JSON.stringify({id: chore.id, points: chore.points})}>
                                                {chore.icon} {chore.name} ({chore.points} pts)
                                            </option>
                                        ))}
                                    </select>
                                    <input
                                        id="backfill-date"
                                        type="date"
                                        max={new Date().toISOString().split('T')[0]}
                                        style={{
                                            padding: '12px',
                                            borderRadius: '8px',
                                            border: `1px solid ${theme.outline}`,
                                            background: theme.surface,
                                            color: theme.text,
                                            fontSize: '1rem'
                                        }}
                                    />
                                    <button
                                        className="material-button ripple"
                                        onClick={() => {
                                            const playerId = document.getElementById('backfill-player').value;
                                            const choreData = document.getElementById('backfill-chore').value;
                                            const date = document.getElementById('backfill-date').value;

                                            if (!playerId || !choreData || !date) {
                                                haptic('error');
                                                alert('âŒ Please fill in all fields');
                                                return;
                                            }

                                            const {id: choreId, points} = JSON.parse(choreData);

                                            if (confirm(`Add backfill entry for ${date}?`)) {
                                                addBackfillChore(playerId, choreId, date, points);
                                            }
                                        }}
                                        style={{
                                            background: theme.success,
                                            color: '#FFFFFF',
                                            padding: '12px'
                                        }}
                                    >
                                        Add Backfill Entry
                                    </button>
                                </div>
                            </div>

                            {/* Reset Cooldowns */}
                            <div className="material-card elevation-1" style={{
                                padding: '20px',
                                background: theme.cardBg,
                                marginBottom: '24px'
                            }}>
                                <h2 style={{
                                    fontSize: '1.125rem',
                                    fontWeight: '500',
                                    marginBottom: '16px',
                                    color: theme.cardText
                                }}>
                                    ðŸ”„ Reset Cooldowns
                                </h2>
                                <p style={{
                                    fontSize: '0.875rem',
                                    color: theme.textSecondary,
                                    marginBottom: '12px',
                                    lineHeight: '1.5'
                                }}>
                                    Clear all current chore cooldowns to make all chores available for all players.
                                </p>
                                <button
                                    className="material-button ripple"
                                    onClick={resetCooldowns}
                                    style={{
                                        background: theme.secondary || '#FFA726',
                                        color: theme.onSecondary || '#000000',
                                        padding: '12px',
                                        width: '100%'
                                    }}
                                >
                                    ðŸ”„ Reset All Cooldowns
                                </button>
                            </div>

                            {/* Combined Logs Section */}
                            <div className="material-card elevation-1" style={{
                                padding: '20px',
                                background: theme.cardBg,
                                marginBottom: '24px'
                            }}>
                                <h2 style={{
                                    fontSize: '1.125rem',
                                    fontWeight: '500',
                                    marginBottom: '16px',
                                    color: theme.cardText
                                }}>
                                    ðŸ“Š System Logs
                                </h2>

                                {/* Tab Buttons */}
                                <div style={{
                                    display: 'flex',
                                    gap: '8px',
                                    marginBottom: '16px',
                                    borderBottom: `2px solid ${theme.outline}`,
                                    paddingBottom: '8px'
                                }}>
                                    <button
                                        className="material-button ripple"
                                        onClick={() => setActiveLogTab('errors')}
                                        style={{
                                            background: activeLogTab === 'errors' ? theme.primary : 'transparent',
                                            color: activeLogTab === 'errors' ? theme.onPrimary : theme.text,
                                            padding: '8px 16px',
                                            fontSize: '0.875rem',
                                            border: activeLogTab === 'errors' ? 'none' : `1px solid ${theme.outline}`
                                        }}
                                    >
                                        ðŸ”’ Error Logs
                                    </button>
                                    <button
                                        className="material-button ripple"
                                        onClick={() => setActiveLogTab('activity')}
                                        style={{
                                            background: activeLogTab === 'activity' ? theme.primary : 'transparent',
                                            color: activeLogTab === 'activity' ? theme.onPrimary : theme.text,
                                            padding: '8px 16px',
                                            fontSize: '0.875rem',
                                            border: activeLogTab === 'activity' ? 'none' : `1px solid ${theme.outline}`
                                        }}
                                    >
                                        ðŸ“ Activity Logs
                                    </button>
                                </div>

                                {/* Error Logs Tab Content */}
                                {activeLogTab === 'errors' && (
                                    <div>

                                {/* Error Statistics */}
                                {errorStats.length > 0 && (
                                    <div style={{
                                        marginBottom: '20px',
                                        padding: '12px',
                                        background: darkMode ? 'rgba(239, 83, 80, 0.1)' : 'rgba(239, 83, 80, 0.05)',
                                        borderRadius: '8px'
                                    }}>
                                        <div style={{
                                            fontSize: '0.875rem',
                                            fontWeight: '600',
                                            marginBottom: '8px',
                                            color: theme.cardText
                                        }}>
                                            ðŸ“Š Error Summary
                                        </div>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                            {errorStats.map((stat, idx) => (
                                                <div key={idx} style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    fontSize: '0.8125rem',
                                                    color: theme.textSecondary
                                                }}>
                                                    <span style={{ textTransform: 'capitalize' }}>
                                                        {stat.error_type.replace('_', ' ')}:
                                                    </span>
                                                    <span style={{ fontWeight: '600', color: '#EF5350' }}>
                                                        {stat.count} occurrences
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Recent Error Logs */}
                                <div style={{
                                    fontSize: '0.875rem',
                                    fontWeight: '600',
                                    marginBottom: '12px',
                                    color: theme.cardText
                                }}>
                                    ðŸ“‹ Recent Events (Last 50)
                                </div>

                                {errorLogs.length === 0 ? (
                                    <div style={{
                                        textAlign: 'center',
                                        padding: '32px',
                                        color: theme.textSecondary
                                    }}>
                                        âœ… No errors logged yet
                                    </div>
                                ) : (
                                    <div style={{
                                        maxHeight: '400px',
                                        overflowY: 'auto',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        gap: '8px'
                                    }}>
                                        {errorLogs.map(log => (
                                            <div key={log.id} style={{
                                                padding: '12px',
                                                background: theme.surface,
                                                borderRadius: '8px',
                                                borderLeft: `4px solid ${
                                                    log.error_type === 'login_failed' ? '#FF9800' :
                                                    log.error_type === 'admin_failed' ? '#EF5350' :
                                                    '#9E9E9E'
                                                }`
                                            }}>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'flex-start',
                                                    marginBottom: '8px'
                                                }}>
                                                    <div style={{
                                                        fontSize: '0.8125rem',
                                                        fontWeight: '600',
                                                        color: theme.cardText,
                                                        textTransform: 'capitalize'
                                                    }}>
                                                        {log.error_type === 'login_failed' ? 'âš ï¸ Failed Login' :
                                                         log.error_type === 'admin_failed' ? 'ðŸš¨ Failed Admin Access' :
                                                         'âŒ ' + log.error_type.replace('_', ' ')}
                                                    </div>
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        color: theme.textSecondary
                                                    }}>
                                                        {log.logged_at ? new Date(log.logged_at).toLocaleString() : 'N/A'}
                                                    </div>
                                                </div>

                                                {log.error_message && (
                                                    <div style={{
                                                        fontSize: '0.8125rem',
                                                        color: theme.textSecondary,
                                                        marginBottom: '6px'
                                                    }}>
                                                        {log.error_message}
                                                    </div>
                                                )}

                                                {log.user_input && (
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        color: '#EF5350',
                                                        fontFamily: 'monospace',
                                                        padding: '4px 8px',
                                                        background: darkMode ? 'rgba(239, 83, 80, 0.1)' : 'rgba(239, 83, 80, 0.05)',
                                                        borderRadius: '4px',
                                                        marginBottom: '6px'
                                                    }}>
                                                        Attempted: "{log.user_input}"
                                                    </div>
                                                )}

                                                {log.device_info && (
                                                    <details style={{
                                                        fontSize: '0.75rem',
                                                        color: theme.textSecondary,
                                                        marginTop: '8px'
                                                    }}>
                                                        <summary style={{ cursor: 'pointer', marginBottom: '4px' }}>
                                                            Device Info
                                                        </summary>
                                                        <div style={{
                                                            fontFamily: 'monospace',
                                                            fontSize: '0.6875rem',
                                                            padding: '8px',
                                                            background: darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)',
                                                            borderRadius: '4px',
                                                            whiteSpace: 'pre-wrap',
                                                            wordBreak: 'break-word'
                                                        }}>
                                                            Platform: {log.device_info.platform}<br />
                                                            Language: {log.device_info.language}<br />
                                                            Screen: {log.device_info.screenWidth}x{log.device_info.screenHeight}<br />
                                                            Timezone: {log.device_info.timezone}
                                                        </div>
                                                    </details>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                                    </div>
                                )}

                                {/* Activity Logs Tab Content */}
                                {activeLogTab === 'activity' && (
                                    <div>
                                <div style={{
                                    fontSize: '0.875rem',
                                    fontWeight: '600',
                                    marginBottom: '12px',
                                    color: theme.cardText
                                }}>
                                    ðŸ“‹ Recent Activities (Last 50)
                                </div>

                                {activityLogs.length === 0 ? (
                                    <div style={{
                                        textAlign: 'center',
                                        padding: '32px',
                                        color: theme.textSecondary
                                    }}>
                                        No activities logged yet
                                    </div>
                                ) : (
                                    <div style={{
                                        maxHeight: '400px',
                                        overflowY: 'auto',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        gap: '8px'
                                    }}>
                                        {activityLogs.map(log => (
                                            <div key={log.id} style={{
                                                padding: '12px',
                                                background: theme.surface,
                                                borderRadius: '8px',
                                                borderLeft: `4px solid ${
                                                    log.activity_type === 'name_change' ? theme.primary :
                                                    log.activity_type === 'avatar_change' ? theme.accent :
                                                    theme.success
                                                }`
                                            }}>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'flex-start',
                                                    marginBottom: '8px'
                                                }}>
                                                    <div style={{
                                                        fontSize: '0.8125rem',
                                                        fontWeight: '600',
                                                        color: theme.cardText,
                                                        textTransform: 'capitalize'
                                                    }}>
                                                        {log.activity_type === 'name_change' ? 'âœï¸ Name Changed' :
                                                         log.activity_type === 'avatar_change' ? 'ðŸŽ­ Avatar Changed' :
                                                         'ðŸ“Œ ' + log.activity_type.replace('_', ' ')}
                                                    </div>
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        color: theme.textSecondary
                                                    }}>
                                                        {log.logged_at ? new Date(log.logged_at).toLocaleString() : 'N/A'}
                                                    </div>
                                                </div>

                                                {log.description && (
                                                    <div style={{
                                                        fontSize: '0.8125rem',
                                                        color: theme.textSecondary,
                                                        marginBottom: '6px'
                                                    }}>
                                                        {log.description}
                                                    </div>
                                                )}

                                                {log.player_name && (
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        color: theme.primary,
                                                        fontWeight: '500'
                                                    }}>
                                                        Player: {log.player_name}
                                                    </div>
                                                )}

                                                {log.old_value && log.new_value && (
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        color: theme.textSecondary,
                                                        marginTop: '6px',
                                                        padding: '6px 8px',
                                                        background: darkMode ? 'rgba(71, 178, 196, 0.05)' : 'rgba(208, 165, 0, 0.05)',
                                                        borderRadius: '4px'
                                                    }}>
                                                        <span style={{ color: '#EF5350', textDecoration: 'line-through' }}>
                                                            {log.old_value}
                                                        </span>
                                                        {' â†’ '}
                                                        <span style={{ color: theme.success, fontWeight: '600' }}>
                                                            {log.new_value}
                                                        </span>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                                    </div>
                                )}
                            </div>

                            {/* Chore Bid Management */}
                            <div className="material-card elevation-1" style={{
                                padding: '20px',
                                background: theme.cardBg,
                                marginBottom: '24px',
                                border: `2px solid #4CAF50`
                            }}>
                                <h2 style={{
                                    fontSize: '1.125rem',
                                    fontWeight: '500',
                                    marginBottom: '16px',
                                    color: theme.cardText
                                }}>
                                    ðŸ’š Player Chore Bids
                                </h2>

                                {choreBids.filter(bid => bid.status === 'pending' || bid.status === 'counter_offered').length === 0 ? (
                                    <div style={{
                                        textAlign: 'center',
                                        padding: '32px',
                                        color: theme.textSecondary
                                    }}>
                                        No pending bids
                                    </div>
                                ) : (
                                    <div style={{
                                        display: 'flex',
                                        flexDirection: 'column',
                                        gap: '12px'
                                    }}>
                                        {choreBids
                                            .filter(bid => bid.status === 'pending' || bid.status === 'counter_offered')
                                            .map(bid => (
                                            <div key={bid.id} className="player-bid-glow" style={{
                                                padding: '16px',
                                                background: theme.surface,
                                                borderRadius: '12px'
                                            }}>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'flex-start',
                                                    marginBottom: '12px'
                                                }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{
                                                            fontSize: '1rem',
                                                            fontWeight: '600',
                                                            color: theme.cardText,
                                                            marginBottom: '4px'
                                                        }}>
                                                            {bid.chore_name}
                                                        </div>
                                                        <div style={{
                                                            fontSize: '0.875rem',
                                                            color: theme.primary,
                                                            fontWeight: '600',
                                                            marginBottom: '4px'
                                                        }}>
                                                            {bid.players?.avatar_url || 'ðŸ‘¤'} {bid.players?.name || 'Unknown Player'}
                                                        </div>
                                                        <div style={{
                                                            fontSize: '0.875rem',
                                                            color: theme.textSecondary
                                                        }}>
                                                            Proposed: {bid.proposed_points} pts
                                                        </div>
                                                        {bid.admin_counter_points && (
                                                            <div style={{
                                                                fontSize: '0.875rem',
                                                                color: '#FFA726',
                                                                fontWeight: '600',
                                                                marginTop: '4px'
                                                            }}>
                                                                Counter-offer: {bid.admin_counter_points} pts
                                                            </div>
                                                        )}
                                                        {bid.admin_notes && (
                                                            <div style={{
                                                                fontSize: '0.75rem',
                                                                color: theme.textSecondary,
                                                                marginTop: '4px',
                                                                fontStyle: 'italic'
                                                            }}>
                                                                Note: {bid.admin_notes}
                                                            </div>
                                                        )}
                                                        {bid.due_date && (
                                                            <div style={{
                                                                fontSize: '0.75rem',
                                                                color: theme.accent,
                                                                marginTop: '4px'
                                                            }}>
                                                                ðŸ“… Due: {new Date(bid.due_date).toLocaleDateString()}
                                                            </div>
                                                        )}
                                                        <div style={{
                                                            fontSize: '0.75rem',
                                                            color: theme.textSecondary,
                                                            marginTop: '4px'
                                                        }}>
                                                            {bid.created_at ? new Date(bid.created_at).toLocaleString() : 'N/A'}
                                                        </div>
                                                        {bid.status === 'counter_offered' && (
                                                            <div style={{
                                                                fontSize: '0.75rem',
                                                                color: '#FFA726',
                                                                fontWeight: '600',
                                                                marginTop: '8px',
                                                                padding: '6px 10px',
                                                                background: 'rgba(255, 167, 38, 0.1)',
                                                                borderRadius: '6px',
                                                                display: 'inline-block'
                                                            }}>
                                                                â³ Awaiting player response
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div style={{
                                                    display: 'flex',
                                                    gap: '8px',
                                                    marginTop: '12px'
                                                }}>
                                                    <button
                                                        className="material-button ripple"
                                                        onClick={() => acceptBid(bid.id)}
                                                        style={{
                                                            flex: 1,
                                                            background: theme.success,
                                                            color: '#FFFFFF',
                                                            fontSize: '0.875rem',
                                                            padding: '8px 12px'
                                                        }}
                                                    >
                                                        âœ… Accept
                                                    </button>
                                                    {bid.status !== 'counter_offered' && (
                                                        <button
                                                            className="material-button ripple"
                                                            onClick={() => counterBid(bid.id)}
                                                            style={{
                                                                flex: 1,
                                                                background: '#FFA726',
                                                                color: '#FFFFFF',
                                                                fontSize: '0.875rem',
                                                                padding: '8px 12px'
                                                            }}
                                                        >
                                                            ðŸ’¬ Counter
                                                        </button>
                                                    )}
                                                    <button
                                                        className="material-button ripple"
                                                        onClick={() => rejectBid(bid.id)}
                                                        style={{
                                                            flex: 1,
                                                            background: theme.error,
                                                            color: '#FFFFFF',
                                                            fontSize: '0.875rem',
                                                            padding: '8px 12px'
                                                        }}
                                                    >
                                                        âŒ Reject
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* Show accepted and rejected bids */}
                                {choreBids.filter(bid => bid.status === 'accepted' || bid.status === 'rejected').length > 0 && (
                                    <div style={{ marginTop: '24px' }}>
                                        <h3 style={{
                                            fontSize: '0.875rem',
                                            fontWeight: '600',
                                            marginBottom: '12px',
                                            color: theme.textSecondary,
                                            textTransform: 'uppercase',
                                            letterSpacing: '1px'
                                        }}>
                                            Processed Bids
                                        </h3>
                                        <div style={{
                                            display: 'flex',
                                            flexDirection: 'column',
                                            gap: '8px',
                                            maxHeight: '300px',
                                            overflowY: 'auto'
                                        }}>
                                            {choreBids
                                                .filter(bid => bid.status === 'accepted' || bid.status === 'rejected')
                                                .map(bid => (
                                                <div key={bid.id} style={{
                                                    padding: '12px',
                                                    background: theme.surface,
                                                    borderRadius: '8px',
                                                    borderLeft: `4px solid ${bid.status === 'accepted' ? theme.success : theme.error}`,
                                                    opacity: 0.7
                                                }}>
                                                    <div style={{
                                                        fontSize: '0.875rem',
                                                        fontWeight: '600',
                                                        color: theme.cardText
                                                    }}>
                                                        {bid.chore_name}
                                                    </div>
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        color: theme.textSecondary
                                                    }}>
                                                        {bid.players?.name} â€¢ {bid.proposed_points} pts â€¢ {bid.status}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Recent Completions */}
                            <div className="material-card elevation-1" style={{
                                padding: '20px',
                                background: theme.cardBg
                            }}>
                                <h2 style={{
                                    fontSize: '1.125rem',
                                    fontWeight: '500',
                                    marginBottom: '4px',
                                    color: theme.cardText
                                }}>
                                    ðŸ“ Recent Completions & Edits
                                </h2>
                                <p style={{
                                    fontSize: '0.875rem',
                                    color: theme.textSecondary,
                                    marginBottom: '16px'
                                }}>
                                    View, filter, and edit completed chores
                                </p>

                                {/* Filters */}
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                    gap: '12px',
                                    marginBottom: '16px',
                                    padding: '12px',
                                    background: theme.surface,
                                    borderRadius: '8px'
                                }}>
                                    <select
                                        value={editChoreFilter.playerId}
                                        onChange={(e) => setEditChoreFilter({...editChoreFilter, playerId: e.target.value})}
                                        style={{
                                            padding: '8px',
                                            borderRadius: '6px',
                                            border: `1px solid ${theme.outline}`,
                                            background: theme.cardBg,
                                            color: theme.text,
                                            fontSize: '0.875rem'
                                        }}
                                    >
                                        <option value="">All Players</option>
                                        {players.map(p => (
                                            <option key={p.id} value={p.id}>{p.name}</option>
                                        ))}
                                    </select>
                                    <select
                                        value={editChoreFilter.status || ''}
                                        onChange={(e) => setEditChoreFilter({...editChoreFilter, status: e.target.value})}
                                        style={{
                                            padding: '8px',
                                            borderRadius: '6px',
                                            border: `1px solid ${theme.outline}`,
                                            background: theme.cardBg,
                                            color: theme.text,
                                            fontSize: '0.875rem'
                                        }}
                                    >
                                        <option value="">All Status</option>
                                        <option value="approved">Approved</option>
                                        <option value="pending">Pending</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                    <input
                                        type="date"
                                        value={editChoreFilter.startDate}
                                        onChange={(e) => setEditChoreFilter({...editChoreFilter, startDate: e.target.value})}
                                        placeholder="Start Date"
                                        style={{
                                            padding: '8px',
                                            borderRadius: '6px',
                                            border: `1px solid ${theme.outline}`,
                                            background: theme.cardBg,
                                            color: theme.text,
                                            fontSize: '0.875rem'
                                        }}
                                    />
                                    <input
                                        type="date"
                                        value={editChoreFilter.endDate}
                                        onChange={(e) => setEditChoreFilter({...editChoreFilter, endDate: e.target.value})}
                                        placeholder="End Date"
                                        style={{
                                            padding: '8px',
                                            borderRadius: '6px',
                                            border: `1px solid ${theme.outline}`,
                                            background: theme.cardBg,
                                            color: theme.text,
                                            fontSize: '0.875rem'
                                        }}
                                    />
                                </div>
                                {allCompletions.length === 0 ? (
                                    <div style={{
                                        textAlign: 'center',
                                        padding: '32px',
                                        color: theme.textSecondary
                                    }}>
                                        No completions found
                                    </div>
                                ) : (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {allCompletions
                                            .filter(completion => {
                                                if (editChoreFilter.playerId && completion.player_id !== editChoreFilter.playerId) return false;
                                                if (editChoreFilter.status && completion.status !== editChoreFilter.status) return false;
                                                if (editChoreFilter.startDate && completion.completed_date < editChoreFilter.startDate) return false;
                                                if (editChoreFilter.endDate && completion.completed_date > editChoreFilter.endDate) return false;
                                                return true;
                                            })
                                            .map(completion => (
                                            <div key={completion.id} className="material-card" style={{
                                                padding: '16px',
                                                background: theme.surface,
                                                borderLeft: `4px solid ${
                                                    completion.status === 'pending' ? '#FFA726' :
                                                    completion.status === 'approved' ? '#66BB6A' : '#EF5350'
                                                }`
                                            }}>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'flex-start',
                                                    gap: '12px'
                                                }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '8px',
                                                            marginBottom: '8px'
                                                        }}>
                                                            <span style={{ fontSize: '1.5rem' }}>
                                                                {completion.players?.avatar_url || 'ðŸ‘¤'}
                                                            </span>
                                                            <span style={{ fontSize: '1.25rem' }}>
                                                                {completion.chores?.icon || 'â“'}
                                                            </span>
                                                            <div>
                                                                <div style={{
                                                                    fontWeight: '500',
                                                                    color: theme.cardText
                                                                }}>
                                                                    {completion.players?.name || 'Unknown'}: {completion.chores?.name || 'Unknown'}
                                                                </div>
                                                                <div style={{
                                                                    fontSize: '0.875rem',
                                                                    color: theme.textSecondary
                                                                }}>
                                                                    {completion.value_awarded} pts â€¢ {completion.status}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div style={{
                                                            fontSize: '0.875rem',
                                                            color: theme.textSecondary
                                                        }}>
                                                            Date: {new Date(completion.completed_date).toLocaleDateString('en-US', {
                                                                weekday: 'short',
                                                                month: 'short',
                                                                day: 'numeric',
                                                                year: 'numeric'
                                                            })}
                                                        </div>
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '8px', flexDirection: 'column', minWidth: '200px' }}>
                                                        <select
                                                            defaultValue={completion.chore_id}
                                                            id={`edit-chore-${completion.id}`}
                                                            style={{
                                                                padding: '6px 8px',
                                                                borderRadius: '6px',
                                                                border: `1px solid ${theme.outline}`,
                                                                background: theme.cardBg,
                                                                color: theme.text,
                                                                fontSize: '0.75rem'
                                                            }}
                                                        >
                                                            {chores.map(chore => (
                                                                <option key={chore.id} value={chore.id}>
                                                                    {chore.icon} {chore.name}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        <input
                                                            type="date"
                                                            defaultValue={completion.completed_date}
                                                            id={`edit-date-${completion.id}`}
                                                            style={{
                                                                padding: '6px 8px',
                                                                borderRadius: '6px',
                                                                border: `1px solid ${theme.outline}`,
                                                                background: theme.cardBg,
                                                                color: theme.text,
                                                                fontSize: '0.75rem'
                                                            }}
                                                        />
                                                        <button
                                                            className="material-button ripple"
                                                            onClick={() => {
                                                                const newChoreId = document.getElementById(`edit-chore-${completion.id}`).value;
                                                                const newDate = document.getElementById(`edit-date-${completion.id}`).value;
                                                                if (confirm('Save changes?')) {
                                                                    editApprovedChore(completion.id, newChoreId, newDate);
                                                                }
                                                            }}
                                                            style={{
                                                                background: theme.success,
                                                                color: '#FFFFFF',
                                                                padding: '6px 12px',
                                                                fontSize: '0.75rem'
                                                            }}
                                                        >
                                                            ðŸ’¾ Save
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Monthly View
            if (showMonthlyView) {
                // Group chores by date
                const choresByDate = {};
                monthlyChores.forEach(chore => {
                    const date = chore.completed_date;
                    if (!choresByDate[date]) {
                        choresByDate[date] = [];
                    }
                    choresByDate[date].push(chore);
                });

                const dates = Object.keys(choresByDate).sort((a, b) => new Date(b) - new Date(a));

                // Get current month name
                const monthName = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                return (
                    <div style={{
                        minHeight: '100vh',
                        background: theme.bg,
                        color: theme.text,
                        padding: '16px'
                    }}>
                        {/* Header with Back Button */}
                        <div className="elevation-2" style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '16px',
                            padding: '12px 20px',
                            marginBottom: '24px',
                            
                            margin: '0 auto 24px',
                            background: theme.surface,
                            borderRadius: '16px',
                            height: '56px'
                        }}>
                            <button
                                onClick={() => setShowMonthlyView(false)}
                                className="fab elevation-1 ripple"
                                style={{
                                    background: theme.primary,
                                    color: theme.onPrimary,
                                    width: '48px',
                                    height: '48px',
                                    fontSize: '1.25rem'
                                }}
                            >
                                â†
                            </button>
                            <h1 style={{
                                fontSize: '1.375rem',
                                fontWeight: '500',
                                margin: 0,
                                fontFamily: "'Google Sans Display', sans-serif"
                            }}>
                                ðŸ“… {monthName}
                            </h1>
                        </div>

                        <div style={{  margin: '0 auto' }}>
                            {dates.length === 0 ? (
                                <div className="material-card elevation-1" style={{
                                    padding: '48px',
                                    background: theme.cardBg,
                                    textAlign: 'center'
                                }}>
                                    <div style={{
                                        fontSize: '3rem',
                                        marginBottom: '16px'
                                    }}>
                                        ðŸ“­
                                    </div>
                                    <div style={{
                                        fontSize: '1.125rem',
                                        color: theme.textSecondary
                                    }}>
                                        No chores completed this month yet
                                    </div>
                                </div>
                            ) : (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                    {dates.map(date => {
                                        const dayChores = choresByDate[date];
                                        const totalPoints = dayChores.reduce((sum, c) => sum + c.value_awarded, 0);

                                        return (
                                            <div key={date} className="material-card elevation-1" style={{
                                                padding: '20px',
                                                background: theme.cardBg
                                            }}>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    marginBottom: '16px',
                                                    paddingBottom: '12px',
                                                    borderBottom: `2px solid ${theme.outline}`
                                                }}>
                                                    <div style={{
                                                        fontSize: '1.125rem',
                                                        fontWeight: '600',
                                                        color: theme.cardText
                                                    }}>
                                                        {new Date(date).toLocaleDateString('en-US', {
                                                            weekday: 'long',
                                                            month: 'long',
                                                            day: 'numeric'
                                                        })}
                                                    </div>
                                                    <div style={{
                                                        fontSize: '1.25rem',
                                                        fontWeight: '700',
                                                        color: theme.primary
                                                    }}>
                                                        {totalPoints} pts
                                                    </div>
                                                </div>

                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                                    {dayChores.map(chore => (
                                                        <div key={chore.id} style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '12px',
                                                            padding: '12px',
                                                            background: theme.surface,
                                                            borderRadius: '12px'
                                                        }}>
                                                            <div style={{ fontSize: '2rem' }}>
                                                                {chore.players?.avatar_url || 'ðŸ‘¤'}
                                                            </div>
                                                            <div style={{ fontSize: '1.5rem' }}>
                                                                {chore.chores?.icon || 'â“'}
                                                            </div>
                                                            <div style={{ flex: 1 }}>
                                                                <div style={{
                                                                    fontWeight: '500',
                                                                    color: theme.cardText,
                                                                    marginBottom: '2px'
                                                                }}>
                                                                    {chore.players?.name || 'Unknown'}: {chore.chores?.name || 'Unknown Chore'}
                                                                </div>
                                                            </div>
                                                            <div style={{
                                                                fontWeight: '600',
                                                                fontSize: '1.125rem',
                                                                color: theme.primary
                                                            }}>
                                                                +{chore.value_awarded}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Profile Page View
            if (showProfile && selectedPlayer) {
                const approvedHistory = playerHistory.filter(h => h.status === 'approved');

                // FIX: Filter chores from the last 7 calendar days (not just 7 chores)
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];

                const last7Days = approvedHistory.filter(h => h.completed_date >= sevenDaysAgoStr);

                // Group by date for daily totals (30-day history)
                const dailyTotals = {};
                approvedHistory.forEach(h => {
                    const date = h.completed_date;
                    if (!dailyTotals[date]) {
                        dailyTotals[date] = { date, points: 0, chores: [] };
                    }
                    dailyTotals[date].points += h.value_awarded;
                    dailyTotals[date].chores.push(h);
                });

                const dailyData = Object.values(dailyTotals).sort((a, b) =>
                    new Date(b.date) - new Date(a.date)
                );

                return (
                    <div style={{
                        minHeight: '100vh',
                        background: theme.bg,
                        color: theme.text,
                        padding: '16px'
                    }}>
                        {/* Header with Back Button */}
                        <div className="elevation-2" style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '16px',
                            padding: '12px 20px',
                            marginBottom: '24px',
                            
                            margin: '0 auto 24px',
                            background: theme.surface,
                            borderRadius: '16px',
                            height: '56px'
                        }}>
                            <button
                                onClick={() => setShowProfile(false)}
                                className="fab elevation-1 ripple"
                                style={{
                                    background: theme.primary,
                                    color: theme.onPrimary,
                                    width: '48px',
                                    height: '48px',
                                    fontSize: '1.25rem'
                                }}
                            >
                                â†
                            </button>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flex: 1 }}>
                                <div style={{ fontSize: '2rem' }}>{selectedPlayer.avatar}</div>
                                <h1 style={{
                                    fontSize: '1.375rem',
                                    fontWeight: '500',
                                    margin: 0,
                                    fontFamily: "'Google Sans Display', sans-serif"
                                }}>
                                    {selectedPlayer.name}'s Profile
                                </h1>
                            </div>
                        </div>

                        <div style={{  margin: '0 auto' }}>
                            {/* Stats Grid */}
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                gap: '16px',
                                marginBottom: '24px'
                            }}>
                                {/* Weekly Total */}
                                <div className="material-card elevation-1" style={{
                                    padding: '16px',
                                    background: theme.cardBg,
                                    textAlign: 'center'
                                }}>
                                    <div style={{
                                        fontSize: '0.75rem',
                                        fontWeight: '500',
                                        textTransform: 'uppercase',
                                        color: theme.textSecondary,
                                        marginBottom: '8px'
                                    }}>
                                        This Week
                                    </div>
                                    <div style={{
                                        fontSize: '2rem',
                                        fontWeight: '600',
                                        color: theme.primary
                                    }}>
                                        {(typeof selectedPlayer?.points === 'number' ? selectedPlayer.points : 0).toLocaleString()}
                                    </div>
                                    <div style={{ fontSize: '0.875rem', color: theme.textSecondary }}>points</div>
                                </div>

                                {/* Personal Best */}
                                <div className="material-card elevation-1" style={{
                                    padding: '16px',
                                    background: theme.cardBg,
                                    textAlign: 'center'
                                }}>
                                    <div style={{
                                        fontSize: '0.75rem',
                                        fontWeight: '500',
                                        textTransform: 'uppercase',
                                        color: theme.textSecondary,
                                        marginBottom: '8px'
                                    }}>
                                        Personal Best
                                    </div>
                                    <div style={{
                                        fontSize: '2rem',
                                        fontWeight: '600',
                                        color: theme.accent
                                    }}>
                                        {(typeof selectedPlayer?.best_week_total === 'number' ? selectedPlayer.best_week_total : 0).toLocaleString()}
                                    </div>
                                    <div style={{ fontSize: '0.875rem', color: theme.textSecondary }}>points</div>
                                </div>

                                {/* Total Chores */}
                                <div className="material-card elevation-1" style={{
                                    padding: '16px',
                                    background: theme.cardBg,
                                    textAlign: 'center'
                                }}>
                                    <div style={{
                                        fontSize: '0.75rem',
                                        fontWeight: '500',
                                        textTransform: 'uppercase',
                                        color: theme.textSecondary,
                                        marginBottom: '8px'
                                    }}>
                                        Total Chores
                                    </div>
                                    <div style={{
                                        fontSize: '2rem',
                                        fontWeight: '600',
                                        color: theme.success
                                    }}>
                                        {selectedPlayer.completedChores}
                                    </div>
                                    <div style={{ fontSize: '0.875rem', color: theme.textSecondary }}>completed</div>
                                </div>

                                {/* Weekly Payout */}
                                <div className="material-card elevation-1" style={{
                                    padding: '16px',
                                    background: theme.cardBg,
                                    textAlign: 'center'
                                }}>
                                    <div style={{
                                        fontSize: '0.75rem',
                                        fontWeight: '500',
                                        textTransform: 'uppercase',
                                        color: theme.textSecondary,
                                        marginBottom: '8px'
                                    }}>
                                        Weekly Payout
                                    </div>
                                    <div style={{
                                        fontSize: '2rem',
                                        fontWeight: '600',
                                        color: '#2E7D32'
                                    }}>
                                        ${calculateTieredPayout(selectedPlayer.points).total.toFixed(2)}
                                    </div>
                                    <div style={{
                                        fontSize: '0.75rem',
                                        color: theme.textSecondary,
                                        marginTop: '4px'
                                    }}>
                                        {payoutDate}
                                    </div>
                                </div>
                            </div>

                            {/* Payout Breakdown */}
                            {(() => {
                                const payout = calculateTieredPayout(selectedPlayer.points);
                                if (payout.breakdown.length > 0) {
                                    return (
                                        <div className="material-card elevation-1" style={{
                                            padding: '16px',
                                            background: theme.cardBg,
                                            marginBottom: '16px'
                                        }}>
                                            <div style={{
                                                fontSize: '1rem',
                                                fontWeight: '600',
                                                marginBottom: '12px',
                                                color: theme.cardText
                                            }}>
                                                ðŸ’µ Payout Breakdown
                                            </div>
                                            {payout.breakdown.map((tier, idx) => (
                                                <div key={idx} style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    padding: '8px',
                                                    marginBottom: '4px',
                                                    background: darkMode ? 'rgba(71, 178, 196, 0.05)' : 'rgba(208, 165, 0, 0.05)',
                                                    borderRadius: '6px'
                                                }}>
                                                    <div style={{ fontSize: '0.875rem', color: theme.cardText }}>
                                                        <strong>Tier {tier.tier}:</strong> {(typeof tier.points === 'number' ? tier.points : 0).toLocaleString()} pts @ {tier.rate}
                                                    </div>
                                                    <div style={{
                                                        fontSize: '0.875rem',
                                                        fontWeight: '600',
                                                        color: '#2E7D32'
                                                    }}>
                                                        ${tier.amount.toFixed(2)}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    );
                                }
                            })()}

                            {/* Achievements */}
                            <div className="material-card elevation-1" style={{
                                padding: '16px',
                                background: theme.cardBg,
                                marginBottom: '16px'
                            }}>
                                <h2 style={{
                                    fontSize: '1.25rem',
                                    fontWeight: '500',
                                    marginBottom: '16px',
                                    color: theme.cardText
                                }}>
                                    ðŸ† Achievements
                                </h2>
                                {(() => {
                                    const earned = playerAchievements[selectedPlayer.id] || [];
                                    const stats = playerStats[selectedPlayer.id];

                                    if (earned.length === 0) {
                                        return (
                                            <div style={{
                                                textAlign: 'center',
                                                padding: '32px',
                                                color: theme.textSecondary
                                            }}>
                                                No achievements earned yet. Keep completing chores!
                                            </div>
                                        );
                                    }

                                    // Group achievements by category
                                    const byCategory = {};
                                    earned.forEach(pa => {
                                        const achievement = achievements.find(a => a.id === pa.achievement_id);
                                        if (achievement) {
                                            if (!byCategory[achievement.category]) {
                                                byCategory[achievement.category] = [];
                                            }
                                            byCategory[achievement.category].push(achievement);
                                        }
                                    });

                                    const categoryNames = {
                                        chore_milestone: 'Chore Milestones',
                                        point_milestone: 'Point Milestones',
                                        weekly_performance: 'Weekly Performance',
                                        streak: 'Streaks',
                                        special: 'Special'
                                    };

                                    return (
                                        <div>
                                            {Object.entries(byCategory).map(([category, categoryAchievements]) => (
                                                <div key={category} style={{ marginBottom: '20px' }}>
                                                    <div style={{
                                                        fontSize: '0.875rem',
                                                        fontWeight: '600',
                                                        textTransform: 'uppercase',
                                                        letterSpacing: '0.5px',
                                                        color: theme.textSecondary,
                                                        marginBottom: '12px'
                                                    }}>
                                                        {categoryNames[category]}
                                                    </div>
                                                    <div style={{
                                                        display: 'grid',
                                                        gridTemplateColumns: 'repeat(auto-fill, minmax(min(100%, 110px), 1fr))',
                                                        gap: '8px'
                                                    }}>
                                                        {categoryAchievements.map(achievement => (
                                                            <div key={achievement.id} style={{
                                                                padding: '16px',
                                                                background: theme.surface,
                                                                borderRadius: '12px',
                                                                textAlign: 'center',
                                                                border: `2px solid ${theme.primary}`,
                                                                boxShadow: `0 0 12px ${darkMode ? 'rgba(71, 178, 196, 0.2)' : 'rgba(208, 165, 0, 0.2)'}`
                                                            }}>
                                                                <div style={{ fontSize: '2.5rem', marginBottom: '8px' }}>
                                                                    {achievement.icon}
                                                                </div>
                                                                <div style={{
                                                                    fontSize: '0.75rem',
                                                                    fontWeight: '600',
                                                                    color: theme.cardText,
                                                                    marginBottom: '4px',
                                                                    wordWrap: 'break-word',
                                                                    overflowWrap: 'break-word',
                                                                    hyphens: 'auto'
                                                                }}>
                                                                    {achievement.name}
                                                                </div>
                                                                <div style={{
                                                                    fontSize: '0.6875rem',
                                                                    color: theme.textSecondary,
                                                                    wordWrap: 'break-word',
                                                                    overflowWrap: 'break-word',
                                                                    hyphens: 'auto',
                                                                    lineHeight: '1.3'
                                                                }}>
                                                                    {achievement.description}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}

                                            {/* Stats Summary */}
                                            {stats && (
                                                <div style={{
                                                    marginTop: '20px',
                                                    padding: '16px',
                                                    background: theme.surface,
                                                    borderRadius: '12px'
                                                }}>
                                                    <div style={{
                                                        fontSize: '0.875rem',
                                                        fontWeight: '600',
                                                        color: theme.textSecondary,
                                                        marginBottom: '12px'
                                                    }}>
                                                        Progress Stats
                                                    </div>
                                                    <div style={{
                                                        display: 'grid',
                                                        gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                                        gap: '12px',
                                                        fontSize: '0.8125rem'
                                                    }}>
                                                        <div>
                                                            <span style={{ color: theme.textSecondary }}>Current Streak:</span>
                                                            <span style={{ fontWeight: '600', color: theme.primary, marginLeft: '4px' }}>
                                                                ðŸ”¥ {stats.current_streak || 0} days
                                                            </span>
                                                        </div>
                                                        <div>
                                                            <span style={{ color: theme.textSecondary }}>Longest Streak:</span>
                                                            <span style={{ fontWeight: '600', color: theme.accent, marginLeft: '4px' }}>
                                                                âš¡ {stats.longest_streak || 0} days
                                                            </span>
                                                        </div>
                                                        <div>
                                                            <span style={{ color: theme.textSecondary }}>GOAT Wins:</span>
                                                            <span style={{ fontWeight: '600', color: '#FFD700', marginLeft: '4px' }}>
                                                                ðŸ {stats.goat_wins || 0}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })()}
                            </div>

                            {/* Player's Bids */}
                            {choreBids.filter(bid => bid.player_id === selectedPlayer.id).length > 0 && (
                                <div className="material-card elevation-1" style={{
                                    padding: '16px',
                                    background: theme.cardBg,
                                    marginBottom: '16px'
                                }}>
                                    <h2 style={{
                                        fontSize: '1.25rem',
                                        fontWeight: '500',
                                        marginBottom: '16px',
                                        color: theme.cardText
                                    }}>
                                        ðŸ“‹ Your Task Bids
                                    </h2>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {choreBids
                                            .filter(bid => bid.player_id === selectedPlayer.id)
                                            .map(bid => (
                                            <div key={bid.id}
                                                className={bid.status === 'pending' || bid.status === 'counter_offered' ? 'player-bid-glow' : ''}
                                                style={{
                                                    padding: '12px',
                                                    background: theme.surface,
                                                    borderRadius: '12px',
                                                    borderLeft: `4px solid ${
                                                        bid.status === 'accepted' ? theme.success :
                                                        bid.status === 'rejected' ? theme.error :
                                                        bid.status === 'counter_offered' ? '#FFA726' :
                                                        '#4CAF50'
                                                    }`
                                                }}>
                                                <div style={{
                                                    fontSize: '1rem',
                                                    fontWeight: '600',
                                                    color: theme.cardText,
                                                    marginBottom: '4px'
                                                }}>
                                                    {bid.chore_name}
                                                </div>
                                                <div style={{
                                                    fontSize: '0.875rem',
                                                    color: theme.textSecondary,
                                                    marginBottom: '4px'
                                                }}>
                                                    Your bid: {bid.proposed_points} pts
                                                </div>
                                                {bid.admin_counter_points && (
                                                    <div style={{
                                                        fontSize: '0.875rem',
                                                        color: '#FFA726',
                                                        fontWeight: '600',
                                                        marginBottom: '4px'
                                                    }}>
                                                        Admin counter-offer: {bid.admin_counter_points} pts
                                                    </div>
                                                )}
                                                {bid.admin_notes && (
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        color: theme.textSecondary,
                                                        marginBottom: '4px',
                                                        fontStyle: 'italic',
                                                        padding: '8px',
                                                        background: darkMode ? 'rgba(255, 167, 38, 0.1)' : 'rgba(255, 167, 38, 0.05)',
                                                        borderRadius: '6px'
                                                    }}>
                                                        Admin note: {bid.admin_notes}
                                                    </div>
                                                )}
                                                {bid.due_date && (
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        color: theme.accent,
                                                        marginBottom: '4px'
                                                    }}>
                                                        ðŸ“… Due: {new Date(bid.due_date).toLocaleDateString()}
                                                    </div>
                                                )}
                                                <div style={{
                                                    display: 'inline-block',
                                                    fontSize: '0.75rem',
                                                    padding: '4px 10px',
                                                    borderRadius: '12px',
                                                    marginTop: '8px',
                                                    background:
                                                        bid.status === 'accepted' ? 'rgba(129, 201, 149, 0.2)' :
                                                        bid.status === 'rejected' ? 'rgba(242, 139, 130, 0.2)' :
                                                        bid.status === 'counter_offered' ? 'rgba(255, 167, 38, 0.2)' :
                                                        'rgba(76, 175, 80, 0.2)',
                                                    color:
                                                        bid.status === 'accepted' ? theme.success :
                                                        bid.status === 'rejected' ? theme.error :
                                                        bid.status === 'counter_offered' ? '#FFA726' :
                                                        '#4CAF50',
                                                    fontWeight: '600'
                                                }}>
                                                    {bid.status === 'pending' ? 'â³ Pending Review' :
                                                     bid.status === 'counter_offered' ? 'ðŸ’¬ Counter-Offer' :
                                                     bid.status === 'accepted' ? 'âœ… Accepted' :
                                                     'âŒ Rejected'}
                                                </div>
                                                {bid.status === 'counter_offered' && (
                                                    <button
                                                        className="material-button ripple"
                                                        onClick={() => acceptCounterOffer(bid.id)}
                                                        style={{
                                                            width: '100%',
                                                            marginTop: '12px',
                                                            background: '#4CAF50',
                                                            color: '#FFFFFF',
                                                            fontSize: '0.875rem'
                                                        }}
                                                    >
                                                        âœ… Accept Counter-Offer ({bid.admin_counter_points} pts)
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Last 7 Days */}
                            <div className="material-card elevation-1" style={{
                                padding: '16px',
                                background: theme.cardBg,
                                marginBottom: '16px'
                            }}>
                                <h2 style={{
                                    fontSize: '1.25rem',
                                    fontWeight: '500',
                                    marginBottom: '16px',
                                    color: theme.cardText
                                }}>
                                    Last 7 Days
                                </h2>
                                {last7Days.length === 0 ? (
                                    <div style={{
                                        textAlign: 'center',
                                        padding: '32px',
                                        color: theme.textSecondary
                                    }}>
                                        No completed chores in the last 7 days
                                    </div>
                                ) : (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                        {last7Days.map((chore) => (
                                            <div key={chore.id || chore.completed_at} style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '12px',
                                                padding: '12px',
                                                background: theme.surface,
                                                borderRadius: '12px'
                                            }}>
                                                <div style={{ fontSize: '1.5rem' }}>{chore.chores?.icon || 'â“'}</div>
                                                <div style={{ flex: 1 }}>
                                                    <div style={{
                                                        fontWeight: '500',
                                                        color: theme.cardText
                                                    }}>
                                                        {chore.chores?.name || 'Unknown Chore'}
                                                    </div>
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        color: theme.textSecondary
                                                    }}>
                                                        {new Date(chore.completed_date).toLocaleDateString('en-US', {
                                                            weekday: 'short',
                                                            month: 'short',
                                                            day: 'numeric'
                                                        })}
                                                    </div>
                                                </div>
                                                <div style={{
                                                    fontWeight: '600',
                                                    color: theme.primary
                                                }}>
                                                    +{chore.value_awarded}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* 30-Day Log */}
                            <div className="material-card elevation-1" style={{
                                padding: '20px',
                                background: theme.cardBg
                            }}>
                                <h2 style={{
                                    fontSize: '1.25rem',
                                    fontWeight: '500',
                                    marginBottom: '16px',
                                    color: theme.cardText
                                }}>
                                    30-Day History
                                </h2>
                                {dailyData.length === 0 ? (
                                    <div style={{
                                        textAlign: 'center',
                                        padding: '32px',
                                        color: theme.textSecondary
                                    }}>
                                        No chore history yet
                                    </div>
                                ) : (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {dailyData.map((day) => (
                                            <div key={day.date} className="material-card" style={{
                                                padding: '16px',
                                                background: theme.surface,
                                                borderLeft: `4px solid ${theme.primary}`
                                            }}>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    marginBottom: '8px'
                                                }}>
                                                    <div style={{
                                                        fontWeight: '600',
                                                        color: theme.cardText
                                                    }}>
                                                        {new Date(day.date).toLocaleDateString('en-US', {
                                                            weekday: 'long',
                                                            month: 'long',
                                                            day: 'numeric'
                                                        })}
                                                    </div>
                                                    <div style={{
                                                        fontWeight: '700',
                                                        fontSize: '1.125rem',
                                                        color: theme.primary
                                                    }}>
                                                        {day.points} pts
                                                    </div>
                                                </div>
                                                <div style={{
                                                    fontSize: '0.875rem',
                                                    color: theme.textSecondary
                                                }}>
                                                    {day.chores.map(c => c.chores?.name || 'Unknown Chore').join(', ')}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // If not logged in, show login screen
            if (!isLoggedIn) {
                return (
                    <div style={{
                        minHeight: '100vh',
                        background: darkMode ? '#121212' : '#f5f5f5',
                        fontFamily: "'Google Sans', -apple-system, BlinkMacSystemFont, sans-serif"
                    }}>
                        {/* Top Navigation Bar with Password */}
                        <nav style={{
                            position: 'sticky',
                            top: 0,
                            zIndex: 1000,
                            background: darkMode ? '#1E1E1E' : '#FFFFFF',
                            borderBottom: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`,
                            padding: '12px 24px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                        }}>
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '16px'
                            }}>
                                <img
                                    src={darkMode ? 'gyattchores-logo-white.svg' : 'gyattchores-logo.svg'}
                                    alt="GyattChores Logo"
                                    style={{
                                        width: '48px',
                                        height: '48px'
                                    }}
                                />
                                <div>
                                    <h1 style={{
                                        fontSize: '1.5rem',
                                        fontWeight: '500',
                                        margin: 0,
                                        color: darkMode ? '#E0E0E0' : '#202124'
                                    }}>
                                        GyattChores
                                    </h1>
                                    <p style={{
                                        fontSize: '0.75rem',
                                        margin: 0,
                                        color: darkMode ? '#9E9E9E' : '#5F6368'
                                    }}>
                                        Family Chore Tracker
                                    </p>
                                </div>
                            </div>

                            <form onSubmit={handleLogin} style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px'
                            }}>
                                <input
                                    type="password"
                                    value={loginPassword}
                                    onChange={(e) => setLoginPassword(e.target.value)}
                                    placeholder="Enter password"
                                    autoFocus
                                    style={{
                                        padding: '10px 16px',
                                        fontSize: '0.9375rem',
                                        border: `1px solid ${darkMode ? '#333' : '#dadce0'}`,
                                        borderRadius: '8px',
                                        background: darkMode ? '#2C2C2C' : '#FFFFFF',
                                        color: darkMode ? '#E0E0E0' : '#202124',
                                        outline: 'none',
                                        transition: 'border-color 0.2s',
                                        minWidth: '200px'
                                    }}
                                    onFocus={(e) => {
                                        e.target.style.borderColor = '#1a73e8';
                                    }}
                                    onBlur={(e) => {
                                        e.target.style.borderColor = darkMode ? '#333' : '#dadce0';
                                    }}
                                />
                                <button
                                    type="submit"
                                    className="material-button elevation-1 ripple"
                                    style={{
                                        padding: '10px 24px',
                                        fontSize: '0.9375rem',
                                        fontWeight: '500',
                                        background: '#1a73e8',
                                        color: '#FFFFFF',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        transition: 'background 0.2s',
                                        whiteSpace: 'nowrap'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.target.style.background = '#1557b0';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.target.style.background = '#1a73e8';
                                    }}
                                >
                                    Login
                                </button>
                            </form>
                        </nav>

                        {loginError && (
                            <div style={{
                                margin: '16px 24px 0',
                                padding: '12px',
                                background: 'rgba(244, 67, 54, 0.1)',
                                border: '1px solid rgba(244, 67, 54, 0.3)',
                                borderRadius: '8px',
                                color: '#f44336',
                                fontSize: '0.875rem'
                            }}>
                                {loginError}
                            </div>
                        )}

                        {/* Single Column Layout */}
                        <div style={{
                            maxWidth: '800px',
                            margin: '0 auto',
                            padding: '32px 24px',
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '32px'
                        }}>
                            {/* The Story */}
                            <div className="material-card elevation-2" style={{
                                padding: '32px',
                                background: darkMode ? '#1E1E1E' : '#FFFFFF',
                                borderRadius: '16px',
                                textAlign: 'center',
                                position: 'relative'
                            }}>
                                {/* Status Orb */}
                                <div style={{
                                    position: 'absolute',
                                    top: '20px',
                                    right: '20px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '8px 16px',
                                    background: darkMode ? 'rgba(76, 175, 80, 0.15)' : 'rgba(76, 175, 80, 0.1)',
                                    borderRadius: '20px',
                                    border: `1px solid ${darkMode ? '#4CAF50' : '#66BB6A'}`
                                }}>
                                    <div style={{
                                        width: '10px',
                                        height: '10px',
                                        borderRadius: '50%',
                                        background: '#4CAF50',
                                        boxShadow: '0 0 8px rgba(76, 175, 80, 0.6)',
                                        animation: 'pulse 2s ease-in-out infinite'
                                    }}></div>
                                    <span style={{
                                        fontSize: '0.75rem',
                                        fontWeight: '600',
                                        color: darkMode ? '#81C784' : '#4CAF50',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px'
                                    }}>
                                        Online
                                    </span>
                                </div>

                                <h2 style={{
                                    fontSize: '1.5rem',
                                    fontWeight: '600',
                                    margin: '0 0 24px 0',
                                    color: darkMode ? '#E0E0E0' : '#202124'
                                }}>
                                    The Story
                                </h2>

                                <p style={{
                                    fontSize: '1.125rem',
                                    fontWeight: '600',
                                    lineHeight: '1.6',
                                    margin: '0 0 20px 0',
                                    color: darkMode ? '#47B2C4' : '#1a73e8'
                                }}>
                                    ðŸ  Made by a Family, for Our Family
                                </p>

                                <p style={{
                                    fontSize: '1rem',
                                    lineHeight: '1.7',
                                    margin: '0 0 16px 0',
                                    color: darkMode ? '#B0B0B0' : '#5F6368'
                                }}>
                                    3 days. 2 kids. 1 goal: make chores suck less.
                                </p>

                                <p style={{
                                    fontSize: '1rem',
                                    lineHeight: '1.7',
                                    margin: '0 0 16px 0',
                                    color: darkMode ? '#B0B0B0' : '#5F6368'
                                }}>
                                    My kids designed the rules. I wrote the code. Now we compete for GOAT status every week and nobody argues about whose turn it is to take out the trash.
                                </p>

                                <p style={{
                                    fontSize: '1rem',
                                    lineHeight: '1.7',
                                    margin: 0,
                                    color: darkMode ? '#B0B0B0' : '#5F6368',
                                    fontStyle: 'italic'
                                }}>
                                    Still a work in progress. We find bugs at dinner and fix them after homework.
                                </p>
                            </div>

                                {/* What's New - Full Changelog */}
                                <div className="material-card elevation-2" style={{
                                    padding: '32px',
                                    background: darkMode ? '#1E1E1E' : '#FFFFFF',
                                    borderRadius: '16px'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '12px',
                                        marginBottom: '32px',
                                        paddingBottom: '16px',
                                        borderBottom: `2px solid ${darkMode ? '#333' : '#e0e0e0'}`
                                    }}>
                                        <div style={{ fontSize: '2rem' }}>ðŸ“‹</div>
                                        <h2 style={{
                                            fontSize: '1.75rem',
                                            fontWeight: '600',
                                            margin: 0,
                                            color: darkMode ? '#E0E0E0' : '#202124'
                                        }}>
                                            What's New
                                        </h2>
                                    </div>

                                    {CHANGELOG.map((update, index) => (
                                        <div key={index} style={{
                                            marginBottom: index < CHANGELOG.length - 1 ? '32px' : '0',
                                            paddingBottom: index < CHANGELOG.length - 1 ? '32px' : '0',
                                            borderBottom: index < CHANGELOG.length - 1 ? `1px solid ${darkMode ? '#333' : '#e0e0e0'}` : 'none'
                                        }}>
                                            <div style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '12px',
                                                marginBottom: '16px',
                                                flexWrap: 'wrap'
                                            }}>
                                                <span style={{
                                                    padding: '6px 14px',
                                                    background: update.type === 'feature'
                                                        ? 'rgba(76, 175, 80, 0.15)'
                                                        : update.type === 'fix'
                                                        ? 'rgba(255, 152, 0, 0.15)'
                                                        : 'rgba(33, 150, 243, 0.15)',
                                                    color: update.type === 'feature'
                                                        ? '#4CAF50'
                                                        : update.type === 'fix'
                                                        ? '#FF9800'
                                                        : '#2196F3',
                                                    borderRadius: '12px',
                                                    fontSize: '0.75rem',
                                                    fontWeight: '700',
                                                    textTransform: 'uppercase',
                                                    letterSpacing: '0.5px'
                                                }}>
                                                    {update.type === 'feature' ? 'âœ¨ New Feature' : update.type === 'fix' ? 'ðŸ”§ Fix' : 'âš¡ Improvement'}
                                                </span>
                                                <span style={{
                                                    fontSize: '1rem',
                                                    fontWeight: '700',
                                                    color: darkMode ? '#47B2C4' : '#1a73e8'
                                                }}>
                                                    v{update.version}
                                                </span>
                                                <span style={{
                                                    fontSize: '0.8125rem',
                                                    color: darkMode ? '#9E9E9E' : '#5F6368'
                                                }}>
                                                    {update.date}{update.time ? ` â€¢ ${update.time}` : ''}
                                                </span>
                                            </div>

                                            <ul style={{
                                                margin: 0,
                                                paddingLeft: '20px',
                                                listStyle: 'none'
                                            }}>
                                                {update.changes.map((change, changeIndex) => (
                                                    <li key={changeIndex} style={{
                                                        fontSize: '0.9375rem',
                                                        lineHeight: '1.7',
                                                        marginBottom: '10px',
                                                        color: darkMode ? '#B0B0B0' : '#3C4043',
                                                        paddingLeft: '8px',
                                                        position: 'relative'
                                                    }}>
                                                        <span style={{
                                                            position: 'absolute',
                                                            left: '-12px',
                                                            color: darkMode ? '#666' : '#999',
                                                            fontWeight: 'bold'
                                                        }}>â€¢</span>
                                                        {change}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    ))}

                                    <div style={{
                                        marginTop: '32px',
                                        padding: '20px',
                                        background: darkMode ? 'rgba(71, 178, 196, 0.1)' : 'rgba(208, 165, 0, 0.1)',
                                        borderRadius: '12px',
                                        textAlign: 'center'
                                    }}>
                                        <p style={{
                                            margin: '0 0 16px 0',
                                            fontSize: '0.875rem',
                                            color: darkMode ? '#47B2C4' : '#D0A500',
                                            fontWeight: '600'
                                        }}>
                                            ðŸ’¡ {CHANGELOG.length} updates total
                                        </p>
                                        <a
                                            href="https://github.com/mattgiss/gyattchores"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '8px',
                                                fontSize: '0.875rem',
                                                color: darkMode ? '#47B2C4' : '#D0A500',
                                                textDecoration: 'none',
                                                fontWeight: '600',
                                                padding: '10px 20px',
                                                borderRadius: '8px',
                                                border: `2px solid ${darkMode ? '#47B2C4' : '#D0A500'}`,
                                                transition: 'all 0.2s ease'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.target.style.background = darkMode ? 'rgba(71, 178, 196, 0.2)' : 'rgba(208, 165, 0, 0.2)';
                                                e.target.style.transform = 'translateY(-2px)';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.target.style.background = 'transparent';
                                                e.target.style.transform = 'translateY(0)';
                                            }}
                                        >
                                            <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                                                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                                            </svg>
                                            View on GitHub
                                        </a>
                                    </div>
                                </div>
                        </div>
                    </div>
                );
            }

            return (
                <div style={{
                    minHeight: '100vh',
                    background: theme.bg,
                    color: theme.text,
                    padding: '12px',
                    fontFamily: "'Google Sans', -apple-system, BlinkMacSystemFont, sans-serif",
                    width: '100%',
                    maxWidth: '100vw',
                    overflow: 'hidden'
                }}>
                    {/* Pull to Refresh Indicator */}
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        height: `${Math.min(pullDistance, 80)}px`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        background: theme.primary,
                        opacity: pullDistance > 0 ? pullDistance / 80 : 0,
                        transition: refreshing ? 'opacity 0.3s' : 'none',
                        zIndex: 9999,
                        pointerEvents: 'none'
                    }}>
                        {refreshing ? (
                            <div style={{
                                width: '24px',
                                height: '24px',
                                border: '3px solid rgba(255,255,255,0.3)',
                                borderTop: '3px solid white',
                                borderRadius: '50%',
                                animation: 'spin 1s linear infinite'
                            }} />
                        ) : (
                            <div style={{
                                color: 'white',
                                fontSize: '0.875rem',
                                fontWeight: '600'
                            }}>
                                {pullDistance > 80 ? 'â†“ Release to refresh' : 'â†“ Pull to refresh'}
                            </div>
                        )}
                    </div>

                    {/* Material Top App Bar */}
                    <div className="elevation-2" style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '8px 12px',
                        marginBottom: '16px',
                        background: theme.surface,
                        borderRadius: '12px',
                        minHeight: '56px'
                    }}>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            minWidth: 0,
                            flex: '0 1 auto'
                        }}>
                            {/* Logo */}
                            <div style={{
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                overflow: 'hidden',
                                flexShrink: 0
                            }}>
                                <svg width="36" height="36" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="256" cy="256" r="230" fill={darkMode ? '#FFFFFF' : '#000000'}/>
                                    <path d="M 180 140 Q 140 140, 140 180 L 140 332 Q 140 372, 180 372 L 260 372 L 260 312 L 200 312 L 200 200 L 260 200 L 260 266 L 300 266 L 300 170 Q 300 140, 270 140 Z"
                                          fill={darkMode ? '#000000' : '#FFFFFF'}/>
                                    <path d="M 360 140 Q 320 140, 320 180 L 320 332 Q 320 372, 360 372 L 372 372 L 372 312 L 360 312 Q 360 312, 360 302 L 360 210 Q 360 200, 372 200 L 372 140 Z"
                                          fill={darkMode ? '#000000' : '#FFFFFF'}/>
                                </svg>
                            </div>
                            <h1 style={{
                                fontSize: '1.125rem',
                                fontWeight: '500',
                                margin: 0,
                                color: theme.text,
                                fontFamily: "'Google Sans Display', sans-serif",
                                letterSpacing: '0',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis',
                                whiteSpace: 'nowrap'
                            }}>
                                GyattChores
                            </h1>
                        </div>
                    </div>

                    {/* Navigation Buttons */}
                    <div className="elevation-1" style={{
                        display: 'flex',
                        gap: '8px',
                        padding: '12px',
                        marginBottom: '16px',
                        background: theme.surface,
                        borderRadius: '12px',
                        flexWrap: 'wrap'
                    }}>
                        <button
                            className="material-button elevation-1 ripple"
                            onClick={async () => {
                                await loadMonthlyChores();
                                setShowMonthlyView(true);
                            }}
                            style={{
                                flex: '1 1 auto',
                                minWidth: '120px',
                                background: theme.accent,
                                color: '#FFFFFF'
                            }}
                            aria-label="View monthly chores"
                        >
                            Monthly View
                        </button>
                        <button
                            className="material-button elevation-1 ripple"
                            onClick={async () => {
                                const code = prompt('Enter admin password:');
                                if (code === APPROVAL_CODE) {
                                    await loadAllCompletions();
                                    await loadErrorLogs();
                                    await loadActivityLogs();
                                    setShowAdminMenu(true);
                                } else if (code !== null) {
                                    haptic('error');
                                    alert('âŒ Invalid admin password');
                                    await logError('admin_failed', 'Incorrect admin password entered from navigation', code);
                                }
                            }}
                            aria-label="Open Admin Panel"
                            style={{
                                flex: '1 1 auto',
                                minWidth: '120px',
                                background: '#FF9800',
                                color: '#FFFFFF'
                            }}
                        >
                            âš™ï¸ Admin
                        </button>
                        <button
                            className="material-button elevation-1 ripple"
                            onClick={handleLogout}
                            aria-label="Logout"
                            style={{
                                flex: '1 1 auto',
                                minWidth: '120px',
                                background: theme.error || '#f44336',
                                color: '#FFFFFF'
                            }}
                        >
                            Logout
                        </button>
                        <button
                            className="material-button elevation-1 ripple"
                            onClick={() => setDarkMode(!darkMode)}
                            aria-label={darkMode ? 'Switch to light mode' : 'Switch to dark mode'}
                            style={{
                                flex: '1 1 auto',
                                minWidth: '120px',
                                background: theme.primary,
                                color: theme.onPrimary
                            }}
                        >
                            {darkMode ? 'Light Mode' : 'Dark Mode'}
                        </button>
                    </div>

                    {/* Achievement Unlock Notifications */}
                    {newAchievements.length > 0 && (
                        <div style={{
                            position: 'fixed',
                            top: '20px',
                            right: '20px',
                            zIndex: 1000,
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '12px',
                            maxWidth: '350px'
                        }}>
                            {newAchievements.map((achievement, idx) => {
                                const player = players.find(p => p.id === achievement.playerId);
                                return (
                                    <div key={`${achievement.id}-${achievement.playerId}-${idx}`}
                                        className="material-card elevation-3"
                                        style={{
                                            padding: '16px',
                                            background: darkMode ? '#1E1E1E' : '#FFFFFF',
                                            border: `2px solid ${theme.primary}`,
                                            boxShadow: '0 8px 24px rgba(0,0,0,0.3)',
                                            animation: 'slideInRight 0.3s ease-out'
                                        }}>
                                        <div style={{
                                            fontSize: '0.6875rem',
                                            fontWeight: '600',
                                            textTransform: 'uppercase',
                                            letterSpacing: '1px',
                                            color: theme.primary,
                                            marginBottom: '8px'
                                        }}>
                                            ðŸ† Achievement Unlocked!
                                        </div>
                                        <div style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px'
                                        }}>
                                            <div style={{ fontSize: '3rem' }}>
                                                {achievement.icon}
                                            </div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{
                                                    fontSize: '1rem',
                                                    fontWeight: '600',
                                                    color: theme.text,
                                                    marginBottom: '4px'
                                                }}>
                                                    {achievement.name}
                                                </div>
                                                <div style={{
                                                    fontSize: '0.8125rem',
                                                    color: theme.textSecondary,
                                                    marginBottom: '4px'
                                                }}>
                                                    {achievement.description}
                                                </div>
                                                {player && (
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        color: theme.primary,
                                                        fontWeight: '500'
                                                    }}>
                                                        {player.avatar} {player.name}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Dashboard Header - Key Info */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))',
                        gap: '20px',
                        padding: '0 20px',
                        margin: '0 0 24px 0'
                    }}>
                        {/* Daily Quote */}
                        {(() => {
                            const dailyQuote = getDailyQuote();
                            return (
                                <div className="material-card elevation-1" style={{
                                    padding: '24px',
                                    background: theme.cardBg,
                                    borderLeft: `4px solid ${theme.primary}`
                                }}>
                                    <div style={{
                                        fontSize: '0.875rem',
                                        fontWeight: '600',
                                        textTransform: 'uppercase',
                                        letterSpacing: '1.5px',
                                        color: theme.textSecondary,
                                        marginBottom: '12px'
                                    }}>
                                        ðŸ’­ Today's Inspiration
                                    </div>
                                    <div style={{
                                        fontSize: '1.25rem',
                                        fontStyle: 'italic',
                                        color: theme.cardText,
                                        marginBottom: '8px',
                                        lineHeight: '1.6'
                                    }}>
                                        "{dailyQuote.quote}"
                                    </div>
                                    <div style={{
                                        fontSize: '1.125rem',
                                        fontWeight: '500',
                                        color: theme.textSecondary
                                    }}>
                                        â€” {dailyQuote.author}
                                    </div>
                                </div>
                            );
                        })()}

                        {/* Weather */}
                        {weather && !weatherLoading && (
                            <div className="material-card elevation-1" style={{
                                padding: '24px',
                                background: theme.cardBg
                            }}>
                                <div style={{
                                    fontSize: '0.875rem',
                                    fontWeight: '600',
                                    textTransform: 'uppercase',
                                    letterSpacing: '1.5px',
                                    color: theme.textSecondary,
                                    marginBottom: '12px'
                                }}>
                                    ðŸŒ¤ï¸ Brighton, CO Weather
                                </div>
                                <div style={{
                                    fontSize: '2.75rem',
                                    fontWeight: '700',
                                    color: theme.primary,
                                    marginBottom: '8px'
                                }}>
                                    {Math.round(weather.temp)}Â°F
                                </div>
                                <div style={{
                                    fontSize: '1.125rem',
                                    color: theme.cardText,
                                    marginBottom: '8px'
                                }}>
                                    {weather.description}
                                </div>
                                <div style={{
                                    fontSize: '1rem',
                                    color: theme.textSecondary
                                }}>
                                    ðŸ‘• {weather.clothing}
                                </div>

                                {/* Tomorrow's Forecast */}
                                {weather.tomorrow && (
                                    <div style={{
                                        marginTop: '20px',
                                        paddingTop: '20px',
                                        borderTop: `1px solid ${theme.outline}`
                                    }}>
                                        <div style={{
                                            fontSize: '0.75rem',
                                            fontWeight: '600',
                                            textTransform: 'uppercase',
                                            letterSpacing: '1px',
                                            color: theme.textSecondary,
                                            marginBottom: '8px'
                                        }}>
                                            ðŸ“… Tomorrow
                                        </div>
                                        <div style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px'
                                        }}>
                                            <div style={{
                                                fontSize: '2rem'
                                            }}>
                                                {weather.tomorrow.icon}
                                            </div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{
                                                    fontSize: '1.125rem',
                                                    fontWeight: '600',
                                                    color: theme.cardText
                                                }}>
                                                    {weather.tomorrow.maxTemp}Â° / {weather.tomorrow.minTemp}Â°F
                                                </div>
                                                <div style={{
                                                    fontSize: '0.875rem',
                                                    color: theme.textSecondary
                                                }}>
                                                    {weather.tomorrow.description}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Next Payout */}
                        <div className="material-card elevation-1" style={{
                            padding: '16px',
                            background: theme.cardBg,
                            textAlign: 'center'
                        }}>
                            <div style={{
                                fontSize: '0.6875rem',
                                fontWeight: '500',
                                textTransform: 'uppercase',
                                letterSpacing: '1px',
                                color: theme.textSecondary,
                                marginBottom: '8px'
                            }}>
                                ðŸ’¸ Next Payout
                            </div>
                            <div style={{
                                fontSize: '1.125rem',
                                fontWeight: '500',
                                color: theme.cardText
                            }}>
                                {payoutDate}
                            </div>
                        </div>

                        {/* Weekly GOAT */}
                        {weeklyGoats.length > 0 && (
                            <div className="material-card elevation-1" style={{
                                padding: '16px',
                                background: theme.cardBg,
                                border: '2px solid #9C27B0',
                                boxShadow: '0 0 16px rgba(156, 39, 176, 0.3), 0 2px 8px 0 rgba(0,0,0,.1)'
                            }}>
                                <div style={{
                                    fontSize: '0.6875rem',
                                    fontWeight: '500',
                                    textTransform: 'uppercase',
                                    letterSpacing: '1px',
                                    color: theme.textSecondary,
                                    marginBottom: '8px'
                                }}>
                                    ðŸ† CURRENT WEEK {weeklyGoats.length > 1 ? 'LEADERS' : 'LEADER'}
                                </div>
                                <div style={{
                                    fontSize: '1.125rem',
                                    fontWeight: '600',
                                    color: '#FFD700',
                                    marginBottom: '4px'
                                }}>
                                    {weeklyGoats.map(g => g.player_name || g.name || 'Unknown').join(' & ')}
                                </div>
                                <div style={{
                                    fontSize: '0.875rem',
                                    color: theme.textSecondary
                                }}>
                                    {(() => {
                                        const goat = weeklyGoats[0];
                                        const points = typeof goat?.weekly_total === 'number' ? goat.weekly_total :
                                                      typeof goat?.points === 'number' ? goat.points : 0;
                                        return points.toLocaleString();
                                    })()} points
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Dashboard Grid */}
                    <div className="dashboard-grid">
                        {/* Players Column */}
                        <div>
                            <div style={{
                                fontSize: '0.75rem',
                                fontWeight: '600',
                                marginBottom: '8px',
                                textTransform: 'uppercase',
                                letterSpacing: '1px',
                                color: theme.textSecondary,
                                paddingLeft: '4px'
                            }}>
                                Players
                            </div>
                            {(players || []).filter(player => player && player.id).map(player => (
                                <div key={player.id} className="material-card elevation-1" style={{
                                    padding: '12px',
                                    marginBottom: '8px',
                                    background: theme.cardBg,
                                    border: isGoat(player.id) ? '2px solid #FFD700' : 'none',
                                    boxShadow: isGoat(player.id)
                                        ? '0 0 12px rgba(255, 215, 0, 0.2), 0 2px 8px 0 rgba(0,0,0,.1)'
                                        : undefined
                                }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                                        <div
                                            onClick={async () => {
                                                const newEmoji = prompt(`Pick a new emoji for ${player.name}:`, player.avatar);
                                                if (newEmoji && newEmoji.trim() && newEmoji !== player.avatar) {
                                                    try {
                                                        const { error } = await supabase
                                                            .from('players')
                                                            .update({ avatar_url: newEmoji.trim() })
                                                            .eq('id', player.id);

                                                        if (error) throw error;

                                                        // Update local state
                                                        setPlayers(prev => prev.map(p =>
                                                            p.id === player.id ? { ...p, avatar: newEmoji.trim() } : p
                                                        ));

                                                        haptic('success');
                                                        alert(`âœ… Avatar updated for ${player.name}!`);
                                                    } catch (error) {
                                                        console.error('Error updating avatar:', error);
                                                        haptic('error');
                                                        alert('Failed to update avatar');
                                                    }
                                                }
                                            }}
                                            style={{
                                            fontSize: '2rem',
                                            width: '48px',
                                            height: '48px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            borderRadius: '50%',
                                            background: darkMode ? 'rgba(71, 178, 196, 0.1)' : 'rgba(208, 165, 0, 0.1)',
                                            cursor: 'pointer',
                                            transition: 'transform 0.2s, background 0.2s',
                                            flexShrink: 0
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.transform = 'scale(1.05)';
                                            e.currentTarget.style.background = darkMode ? 'rgba(71, 178, 196, 0.2)' : 'rgba(208, 165, 0, 0.2)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.transform = 'scale(1)';
                                            e.currentTarget.style.background = darkMode ? 'rgba(71, 178, 196, 0.1)' : 'rgba(208, 165, 0, 0.1)';
                                        }}
                                        title="Click to change avatar"
                                        >
                                            {player.avatar}
                                        </div>
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                            <div
                                                onClick={async () => {
                                                    const newName = prompt(`Enter new name for ${player.name}:`, player.name);
                                                    if (newName && newName.trim() && newName.trim() !== player.name) {
                                                        try {
                                                            const oldName = player.name;
                                                            const trimmedName = newName.trim();

                                                            // Update player name
                                                            const { error } = await supabase
                                                                .from('players')
                                                                .update({ name: trimmedName })
                                                                .eq('id', player.id);

                                                            if (error) throw error;

                                                            // Log the name change to admin activity logs
                                                            await supabase
                                                                .from('admin_activity_logs')
                                                                .insert([{
                                                                    activity_type: 'name_change',
                                                                    player_id: player.id,
                                                                    old_value: oldName,
                                                                    new_value: trimmedName,
                                                                    description: `Player name changed from "${oldName}" to "${trimmedName}"`
                                                                }]);

                                                            // Update local state
                                                            setPlayers(prev => prev.map(p =>
                                                                p.id === player.id ? { ...p, name: trimmedName } : p
                                                            ));

                                                            haptic('success');
                                                            alert(`âœ… Name updated to ${trimmedName}!`);
                                                        } catch (error) {
                                                            console.error('Error updating name:', error);
                                                            haptic('error');
                                                            alert('Failed to update name');
                                                        }
                                                    }
                                                }}
                                                style={{
                                                fontSize: '1rem',
                                                fontWeight: '600',
                                                marginBottom: '2px',
                                                color: theme.cardText,
                                                fontFamily: "'Google Sans Display', sans-serif",
                                                overflow: 'hidden',
                                                textOverflow: 'ellipsis',
                                                whiteSpace: 'nowrap',
                                                cursor: 'pointer',
                                                transition: 'opacity 0.2s'
                                            }}
                                            onMouseEnter={(e) => e.currentTarget.style.opacity = '0.7'}
                                            onMouseLeave={(e) => e.currentTarget.style.opacity = '1'}
                                            title="Click to change name"
                                            >
                                                {player.name}
                                            </div>
                                            <div style={{
                                                fontSize: '0.8125rem',
                                                color: theme.textSecondary
                                            }}>
                                                {player.completedChores} chores
                                            </div>
                                            {(() => {
                                                if (!pendingChores || !player?.id) return null;
                                                const pendingCount = pendingChores.filter(c => c?.playerId === player.id).length;
                                                if (pendingCount > 0) {
                                                    return (
                                                        <div style={{
                                                            fontSize: '0.75rem',
                                                            color: theme.accent,
                                                            fontWeight: '500'
                                                        }}>
                                                            â³ {pendingCount} pending
                                                        </div>
                                                    );
                                                }
                                                return null;
                                            })()}
                                            {isGoat(player.id) && (
                                                <div className="chip" style={{
                                                    background: darkMode ? 'rgba(255, 215, 0, 0.25)' : 'rgba(255, 215, 0, 0.35)',
                                                    color: darkMode ? '#FDB022' : '#8B6914',
                                                    marginTop: '4px',
                                                    fontSize: '0.625rem',
                                                    fontWeight: '600',
                                                    display: 'inline-flex',
                                                    alignItems: 'center',
                                                    gap: '3px',
                                                    padding: '2px 6px'
                                                }}>
                                                    ðŸ {weeklyGoats.length > 1 ? 'CO-GOAT' : 'GOAT'}
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="chip" style={{
                                        background: darkMode ? 'rgba(71, 178, 196, 0.15)' : 'rgba(208, 165, 0, 0.15)',
                                        color: theme.primary,
                                        marginBottom: '6px',
                                        fontWeight: '500',
                                        fontSize: '0.75rem'
                                    }}>
                                        {(typeof player?.points === 'number' ? player.points : 0).toLocaleString()} pts
                                    </div>

                                    {player.completedChores >= 5 && (
                                        <div className="chip" style={{
                                            background: darkMode ? 'rgba(129, 201, 149, 0.15)' : 'rgba(15, 157, 88, 0.15)',
                                            color: theme.success,
                                            fontWeight: '500',
                                            fontSize: '0.6875rem'
                                        }}>
                                            ðŸ’° ${calculateTieredPayout(player.points).total.toFixed(2)}
                                        </div>
                                    )}

                                    {(player.best_week_total || 0) > 0 && (
                                        <div style={{
                                            fontSize: '0.6875rem',
                                            color: theme.textSecondary,
                                            marginTop: '4px'
                                        }}>
                                            ðŸš€ Best: {(typeof player?.best_week_total === 'number' ? player.best_week_total : 0).toLocaleString()} pts
                                        </div>
                                    )}

                                    {/* Bonuses */}
                                    {playerBonuses[player.id] && playerBonuses[player.id].length > 0 && (
                                        <div style={{ marginTop: '6px', display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                                            {playerBonuses[player.id].map((bonus) => (
                                                <div key={bonus.id || `${bonus.bonus_type}-${bonus.awarded_at}`} className="chip" style={{
                                                    background: bonus.bonus_type === 'beat_goat'
                                                        ? (darkMode ? 'rgba(255, 87, 34, 0.2)' : 'rgba(255, 87, 34, 0.15)')
                                                        : (darkMode ? 'rgba(76, 175, 80, 0.2)' : 'rgba(76, 175, 80, 0.15)'),
                                                    color: bonus.bonus_type === 'beat_goat' ? '#FF5722' : '#4CAF50',
                                                    fontWeight: '600',
                                                    fontSize: '0.6875rem',
                                                    padding: '2px 6px'
                                                }}>
                                                    {bonus.bonus_type === 'beat_goat' ? 'ðŸ”¥' : 'ðŸš€'} +{bonus.bonus_amount}
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {/* Latest Achievement */}
                                    {(() => {
                                        const playerAchs = playerAchievements[player.id] || [];
                                        if (playerAchs.length > 0) {
                                            // Get the most recent achievement
                                            const latest = playerAchs.sort((a, b) =>
                                                new Date(b.earned_at) - new Date(a.earned_at)
                                            )[0];
                                            const achievement = achievements.find(a => a.id === latest.achievement_id);

                                            if (achievement) {
                                                return (
                                                    <div style={{
                                                        marginTop: '6px',
                                                        padding: '6px',
                                                        background: theme.surface,
                                                        borderRadius: '6px',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '6px',
                                                        fontSize: '0.6875rem'
                                                    }}>
                                                        <span style={{ fontSize: '1rem' }}>{achievement.icon}</span>
                                                        <div style={{ flex: 1, minWidth: 0 }}>
                                                            <div style={{
                                                                fontWeight: '600',
                                                                color: theme.cardText,
                                                                overflow: 'hidden',
                                                                textOverflow: 'ellipsis',
                                                                whiteSpace: 'nowrap'
                                                            }}>
                                                                {achievement.name}
                                                            </div>
                                                            <div style={{ color: theme.textSecondary, fontSize: '0.625rem' }}>
                                                                {playerAchs.length} {playerAchs.length === 1 ? 'achievement' : 'achievements'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            }
                                        }
                                        return null;
                                    })()}

                                    <button
                                        className="material-button ripple"
                                        onClick={async () => {
                                            setSelectedPlayer(player);
                                            await loadPlayerProfile(player.id);
                                            setShowProfile(true);
                                        }}
                                        style={{
                                            width: '100%',
                                            marginTop: '6px',
                                            padding: '8px 12px',
                                            background: theme.primary,
                                            color: theme.onPrimary,
                                            fontSize: '0.75rem'
                                        }}
                                    >
                                        View Profile
                                    </button>
                                </div>
                            ))}

                            {/* Last Week's GOAT */}
                            {lastWeekGoat && lastWeekGoat.length > 0 && (
                                <div className="material-card elevation-1" style={{
                                    padding: '16px',
                                    background: theme.cardBg,
                                    textAlign: 'center',
                                    marginBottom: '8px',
                                    border: '2px solid #FFD700',
                                    boxShadow: '0 0 16px rgba(255, 215, 0, 0.4), 0 2px 8px 0 rgba(0,0,0,.1)'
                                }}>
                                    <div style={{
                                        fontSize: '0.6875rem',
                                        fontWeight: '500',
                                        textTransform: 'uppercase',
                                        letterSpacing: '1px',
                                        color: theme.textSecondary,
                                        marginBottom: '8px'
                                    }}>
                                        ðŸ {lastWeekGoat.length > 1 ? 'GOATS' : 'GOAT'} OF THE WEEK
                                    </div>
                                    <div style={{
                                        fontSize: '1rem',
                                        fontWeight: '500',
                                        color: theme.cardText
                                    }}>
                                        ðŸ {lastWeekGoat.map(g => g.player_name).join(' & ')}
                                    </div>
                                    <div style={{
                                        fontSize: '0.875rem',
                                        color: theme.textSecondary,
                                        marginTop: '4px'
                                    }}>
                                        {(() => {
                                            const goat = lastWeekGoat[0];
                                            const points = typeof goat?.weekly_total === 'number' ? goat.weekly_total :
                                                          typeof goat?.points === 'number' ? goat.points : 0;
                                            return points.toLocaleString();
                                        })()} points
                                    </div>
                                </div>
                            )}

                            {/* Game Rules */}
                            <div style={{
                                fontSize: '0.6875rem',
                                fontWeight: '500',
                                marginBottom: '16px',
                                textTransform: 'uppercase',
                                letterSpacing: '1px',
                                color: theme.textSecondary,
                                paddingLeft: '8px'
                            }}>
                                Game Rules
                            </div>
                            <div className="material-card elevation-1" style={{
                                padding: '16px',
                                background: theme.cardBg,
                                fontSize: '0.875rem',
                                lineHeight: '1.6',
                                color: theme.cardText
                            }}>
                                <div style={{ marginBottom: '16px' }}>
                                    <div style={{ 
                                        fontWeight: '500', 
                                        marginBottom: '8px',
                                        color: theme.primary,
                                        fontSize: '1rem'
                                    }}>
                                        ðŸ’° Points System
                                    </div>
                                    <div className="text-wrap">
                                        Earn points by completing chores. After 5 completed chores, your dollar amount unlocks!
                                    </div>
                                </div>

                                <div style={{ marginBottom: '16px' }}>
                                    <div style={{ 
                                        fontWeight: '500', 
                                        marginBottom: '8px',
                                        color: theme.primary,
                                        fontSize: '1rem'
                                    }}>
                                        âœ… How to Play
                                    </div>
                                    <div className="text-wrap">
                                        1. Pick a chore<br/>
                                        2. Complete it<br/>
                                        3. Wait for approval<br/>
                                        4. Points added!
                                    </div>
                                </div>

                                <div style={{ marginBottom: '16px' }}>
                                    <div style={{ 
                                        fontWeight: '500', 
                                        marginBottom: '8px',
                                        color: theme.primary,
                                        fontSize: '1rem'
                                    }}>
                                        ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Approval
                                    </div>
                                    <div className="text-wrap">
                                        An admin will review and approve your completed chores.
                                    </div>
                                </div>

                                <div>
                                    <div style={{ 
                                        fontWeight: '500', 
                                        marginBottom: '8px',
                                        color: theme.primary,
                                        fontSize: '1rem'
                                    }}>
                                        ðŸ’¸ Payout
                                    </div>
                                    <div className="text-wrap">
                                        Payments happen on the last Friday of each month. Keep earning!
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Available Chores Column */}
                        <div>
                            <div style={{
                                fontSize: '0.75rem',
                                fontWeight: '600',
                                marginBottom: '8px',
                                textTransform: 'uppercase',
                                letterSpacing: '1px',
                                color: theme.textSecondary,
                                paddingLeft: '4px'
                            }}>
                                Available Chores
                            </div>
                            <div>
                                {chores
                                .sort((a, b) => {
                                    // Custom tasks (â­) first
                                    const aIsCustom = a.icon === 'â­';
                                    const bIsCustom = b.icon === 'â­';
                                    if (aIsCustom && !bIsCustom) return -1;
                                    if (!aIsCustom && bIsCustom) return 1;
                                    return 0;
                                })
                                .filter(chore => {
                                    // Check if chore is available based on per-player cooldown
                                    const availability = getChoreAvailability(chore, selectedPlayer?.id);
                                    return availability.available;
                                }).map((chore, idx) => {
                                    const isCustomTask = chore.icon === 'â­';
                                    return (
                                    <div key={chore.id || idx} className={`material-card elevation-1 ${isCustomTask ? 'player-bid-glow' : ''}`} style={{
                                        marginBottom: '6px',
                                        overflow: 'hidden',
                                        background: theme.cardBg
                                    }}>
                                        <div style={{ padding: '8px' }}>
                                            <div style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                marginBottom: '6px'
                                            }}>
                                                <div style={{
                                                    fontSize: '1.25rem',
                                                    width: '32px',
                                                    height: '32px',
                                                    flexShrink: 0,
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    borderRadius: '6px',
                                                    background: darkMode ? 'rgba(71, 178, 196, 0.1)' : 'rgba(208, 165, 0, 0.1)'
                                                }}>
                                                    {chore.icon}
                                                </div>
                                                <div style={{ flex: 1, minWidth: 0 }}>
                                                    <div style={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '4px',
                                                        marginBottom: '1px'
                                                    }}>
                                                        <div style={{
                                                            fontSize: '0.875rem',
                                                            fontWeight: '600',
                                                            color: theme.cardText,
                                                            overflow: 'hidden',
                                                            textOverflow: 'ellipsis',
                                                            whiteSpace: 'nowrap',
                                                            flex: 1
                                                        }}>
                                                            {chore.name}
                                                        </div>
                                                    </div>
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        fontWeight: '600',
                                                        color: theme.primary
                                                    }}>
                                                        {chore.points} pts
                                                    </div>
                                                    {!isCustomTask && chore.description && (
                                                        <div style={{
                                                            fontSize: '0.6875rem',
                                                            color: theme.textSecondary,
                                                            marginTop: '8px',
                                                            padding: '8px',
                                                            background: darkMode ? 'rgba(71, 178, 196, 0.05)' : 'rgba(208, 165, 0, 0.05)',
                                                            borderRadius: '6px',
                                                            lineHeight: '1.4',
                                                            borderLeft: `3px solid ${theme.primary}`
                                                        }}>
                                                            <strong style={{ color: theme.primary }}>Definition of Done:</strong><br />
                                                            {chore.description}
                                                        </div>
                                                    )}
                                                    {isCustomTask && chore.description && (() => {
                                                        try {
                                                            const desc = JSON.parse(chore.description);
                                                            if (desc.due_date) {
                                                                const dueDate = new Date(desc.due_date);
                                                                const today = new Date();
                                                                today.setHours(0, 0, 0, 0);
                                                                dueDate.setHours(0, 0, 0, 0);
                                                                const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                                                                let dueDateText = '';
                                                                let dueDateColor = theme.textSecondary;

                                                                if (daysUntil < 0) {
                                                                    dueDateText = 'OVERDUE';
                                                                    dueDateColor = theme.error;
                                                                } else if (daysUntil === 0) {
                                                                    dueDateText = 'Due Today!';
                                                                    dueDateColor = theme.error;
                                                                } else if (daysUntil === 1) {
                                                                    dueDateText = 'Due Tomorrow';
                                                                    dueDateColor = theme.accent;
                                                                } else {
                                                                    dueDateText = `Due in ${daysUntil} days`;
                                                                }

                                                                return (
                                                                    <div style={{
                                                                        fontSize: '0.6875rem',
                                                                        fontWeight: '500',
                                                                        color: dueDateColor,
                                                                        marginTop: '2px',
                                                                        overflow: 'hidden',
                                                                        textOverflow: 'ellipsis',
                                                                        whiteSpace: 'nowrap',
                                                                        maxWidth: '100%',
                                                                        width: 'fit-content'
                                                                    }}>
                                                                        ðŸ“… {dueDateText}
                                                                    </div>
                                                                );
                                                            }
                                                        } catch (e) {}
                                                        return null;
                                                    })()}
                                                </div>
                                            </div>
                                            <div style={{
                                                display: 'flex',
                                                flexWrap: 'wrap',
                                                gap: '4px'
                                            }}>
                                                {players
                                                    .filter(player => {
                                                        // Only show player emoji if they are eligible based on their own cooldown
                                                        const availability = getChoreAvailability(chore, player.id);
                                                        return availability.available;
                                                    })
                                                    .map(player => (
                                                    <button
                                                        key={player.id}
                                                        onClick={() => claimChore(player.id, chore)}
                                                        className="ripple"
                                                        style={{
                                                            flex: '1 1 auto',
                                                            minWidth: '48px',
                                                            padding: '8px',
                                                            background: theme.primary,
                                                            color: theme.onPrimary,
                                                            border: 'none',
                                                            cursor: 'pointer',
                                                            fontSize: '1.25rem',
                                                            borderRadius: '8px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center'
                                                        }}
                                                        title={player.name}
                                                        aria-label={`${player.name} claim chore`}
                                                    >
                                                        {player.avatar}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        {isCustomTask && (
                                            <button
                                                onClick={async () => {
                                                    const code = prompt('Enter admin code to delete this custom task:');
                                                    if (code !== APPROVAL_CODE) {
                                                        if (code !== null) {
                                                            haptic('error');
                                                            alert('âŒ Invalid admin code');
                                                        }
                                                        return;
                                                    }

                                                    if (!confirm(`Delete custom task "${chore.name}"?`)) {
                                                        return;
                                                    }

                                                    try {
                                                        const { error } = await supabase
                                                            .from('chores')
                                                            .update({ is_active: false })
                                                            .eq('id', chore.id);

                                                        if (error) throw error;

                                                        setChores(prev => prev.filter(c => c.id !== chore.id));
                                                        haptic('success');
                                                        alert('âœ… Custom task deleted!');
                                                    } catch (error) {
                                                        console.error('Error deleting task:', error);
                                                        haptic('error');
                                                        alert(`Error deleting custom task: ${error.message || 'Unknown error'}`);
                                                    }
                                                }}
                                                className="ripple"
                                                style={{
                                                    width: '100%',
                                                    padding: '10px',
                                                    background: theme.error,
                                                    color: '#FFFFFF',
                                                    border: 'none',
                                                    cursor: 'pointer',
                                                    fontSize: '0.8125rem',
                                                    fontWeight: '500',
                                                    marginTop: '1px'
                                                }}
                                            >
                                                ðŸ—‘ï¸ Cancel Task
                                            </button>
                                        )}
                                    </div>
                                );
                                })}
                            </div>

                            {/* Coming Soon (Chores on Cooldown) */}
                            {(() => {
                                const unavailableChores = chores
                                    .map(chore => ({
                                        ...chore,
                                        availability: getChoreAvailability(chore, selectedPlayer?.id)
                                    }))
                                    .filter(chore => !chore.availability.available)
                                    .sort((a, b) => a.availability.hoursRemaining - b.availability.hoursRemaining);

                                if (unavailableChores.length === 0) return null;

                                return (
                                    <>
                                        <div style={{
                                            fontSize: '0.6875rem',
                                            fontWeight: '500',
                                            textTransform: 'uppercase',
                                            letterSpacing: '1px',
                                            color: theme.textSecondary,
                                            paddingLeft: '8px',
                                            marginTop: '24px',
                                            marginBottom: '8px'
                                        }}>
                                            Coming Soon
                                        </div>
                                        {unavailableChores.map((chore, idx) => {
                                            const days = Math.floor(chore.availability.hoursRemaining / 24);
                                            const hours = chore.availability.hoursRemaining % 24;
                                            let timeText = '';
                                            if (days > 0) {
                                                timeText = `${days}d`;
                                                if (hours > 0) timeText += ` ${hours}h`;
                                            } else {
                                                timeText = `${hours}h`;
                                            }

                                            return (
                                                <div key={chore.id || idx} className="material-card" style={{
                                                    marginBottom: '8px',
                                                    padding: '12px',
                                                    background: theme.cardBg,
                                                    opacity: 0.6,
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px'
                                                }}>
                                                    <div style={{ fontSize: '1.25rem' }}>{chore.icon}</div>
                                                    <div style={{ flex: 1, minWidth: 0 }}>
                                                        <div style={{
                                                            fontSize: '0.875rem',
                                                            fontWeight: '500',
                                                            color: theme.cardText,
                                                            overflow: 'hidden',
                                                            textOverflow: 'ellipsis',
                                                            whiteSpace: 'nowrap'
                                                        }}>
                                                            {chore.name}
                                                        </div>
                                                        <div style={{
                                                            fontSize: '0.75rem',
                                                            color: theme.textSecondary
                                                        }}>
                                                            {chore.points} pts
                                                        </div>
                                                    </div>
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        fontWeight: '500',
                                                        color: theme.primary,
                                                        whiteSpace: 'nowrap'
                                                    }}>
                                                        â³ {timeText}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </>
                                );
                            })()}
                        </div>

                        {/* Pending Approval Column */}
                        <div>
                            <div style={{
                                fontSize: '0.75rem',
                                fontWeight: '600',
                                marginBottom: '8px',
                                textTransform: 'uppercase',
                                letterSpacing: '1px',
                                color: theme.textSecondary,
                                paddingLeft: '4px'
                            }}>
                                Pending Approval
                            </div>

                            {pendingChores.length > 0 && (
                                <div className="material-card elevation-2" style={{
                                    marginBottom: '8px',
                                    padding: '12px',
                                    background: theme.cardBg
                                }}>
                                    <div style={{
                                        fontSize: '0.6875rem',
                                        fontWeight: '500',
                                        marginBottom: '12px',
                                        color: theme.textSecondary,
                                        textTransform: 'uppercase',
                                        letterSpacing: '1px'
                                    }}>
                                        Admin Controls
                                    </div>
                                    <button
                                        className="material-button elevation-1 ripple"
                                        onClick={async () => {
                                            const code = prompt('Enter admin code to approve all:');
                                            if (code !== APPROVAL_CODE) {
                                                if (code !== null) {
                                                    haptic('error');
                                                    alert('âŒ Invalid admin code');
                                                }
                                                return;
                                            }

                                            try {
                                                // Get all pending chores before approving
                                                const { data: pendingToApprove, error: fetchError } = await supabase
                                                    .from('chore_completions')
                                                    .select('player_id, completed_at, value_awarded')
                                                    .eq('status', 'pending');

                                                if (fetchError) throw fetchError;

                                                // Approve all pending chores in database
                                                const { error } = await supabase
                                                    .from('chore_completions')
                                                    .update({ status: 'approved' })
                                                    .eq('status', 'pending');

                                                if (error) throw error;

                                                // Update stats for each approval
                                                if (pendingToApprove && pendingToApprove.length > 0) {
                                                    for (const chore of pendingToApprove) {
                                                        await updatePlayerStats(chore.player_id, chore.completed_at, chore.value_awarded);
                                                    }

                                                    // Check achievements for all affected players
                                                    const uniquePlayers = [...new Set(pendingToApprove.map(c => c.player_id))];
                                                    for (const playerId of uniquePlayers) {
                                                        await checkAndAwardAchievements(playerId);
                                                    }

                                                    // FIX: Refresh stats for all affected players immediately
                                                    const { data: allFreshStats } = await supabase
                                                        .from('player_stats')
                                                        .select('*')
                                                        .in('player_id', uniquePlayers);

                                                    if (allFreshStats) {
                                                        const statsMap = {};
                                                        allFreshStats.forEach(stat => {
                                                            statsMap[stat.player_id] = stat;
                                                        });
                                                        setPlayerStats(prev => ({ ...prev, ...statsMap }));
                                                    }
                                                }

                                                setPendingChores([]);
                                                await loadAllCompletions();
                                                await loadData();

                                                // FIX: If viewing player profile, refresh their history
                                                if (showProfile && selectedPlayer) {
                                                    await loadPlayerProfile(selectedPlayer.id);
                                                }

                                                haptic('success');
                                                alert('âœ… All chores approved!');
                                            } catch (error) {
                                                console.error('Error approving all:', error);
                                                haptic('error');
                                                alert(`Error approving chores: ${error.message || 'Unknown error'}`);
                                            }
                                        }}
                                        style={{
                                            width: '100%',
                                            marginBottom: '8px',
                                            background: theme.success,
                                            color: '#FFFFFF'
                                        }}
                                    >
                                        Approve All ({pendingChores.length})
                                    </button>
                                    <button
                                        className="material-button elevation-1 ripple"
                                        onClick={async () => {
                                            const code = prompt('Enter admin code to reset:');
                                            if (code !== APPROVAL_CODE) {
                                                if (code !== null) {
                                                    haptic('error');
                                                    alert('âŒ Invalid admin code');
                                                }
                                                return;
                                            }

                                            if (!confirm('Clear all pending chores?')) {
                                                return;
                                            }

                                            try {
                                                // Delete all pending chores from database
                                                const { error } = await supabase
                                                    .from('chore_completions')
                                                    .delete()
                                                    .eq('status', 'pending');

                                                if (error) throw error;

                                                setPendingChores([]);
                                                await loadAllCompletions();
                                                await loadData();
                                                haptic('medium');
                                                alert('âœ… Pending chores cleared');
                                            } catch (error) {
                                                console.error('Error clearing pending:', error);
                                                haptic('error');
                                                alert(`Error clearing pending chores: ${error.message || 'Unknown error'}`);
                                            }
                                        }}
                                        style={{
                                            width: '100%',
                                            background: theme.error,
                                            color: '#FFFFFF'
                                        }}
                                    >
                                        Reset Pending
                                    </button>
                                    <button
                                        className="material-button elevation-1 ripple"
                                        onClick={async () => {
                                            const code = prompt('Enter admin code to force weekly reset:');
                                            if (code !== APPROVAL_CODE) {
                                                if (code !== null) {
                                                    haptic('error');
                                                    alert('âŒ Invalid admin code');
                                                }
                                                return;
                                            }

                                            if (!confirm('Force reset weekly points? This starts a new week.')) {
                                                return;
                                            }

                                            const monday = new Date();
                                            const dayOfWeek = monday.getDay();
                                            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                                            monday.setDate(monday.getDate() + daysToMonday);
                                            monday.setHours(0, 0, 0, 0);

                                            setCurrentWeekStart(monday.toISOString().split('T')[0]);
                                            setNeedsWeeklyReset(true);
                                            await performWeeklyReset();
                                        }}
                                        style={{
                                            width: '100%',
                                            marginTop: '8px',
                                            background: theme.accent,
                                            color: '#FFFFFF'
                                        }}
                                    >
                                        Force Weekly Reset
                                    </button>
                                    <button
                                        className="material-button elevation-1 ripple"
                                        onClick={async () => {
                                            const code = prompt('Enter admin code:');
                                            if (code === APPROVAL_CODE) {
                                                await loadAllCompletions();
                                                await loadErrorLogs();
                                                await loadActivityLogs();
                                                setShowAdminMenu(true);
                                            } else if (code !== null) {
                                                haptic('error');
                                                alert('âŒ Invalid admin code');
                                                // Log failed admin access attempt
                                                await logError('admin_failed', 'Incorrect admin code entered', code);
                                            }
                                        }}
                                        style={{
                                            width: '100%',
                                            marginTop: '8px',
                                            background: '#FF9800',
                                            color: '#FFFFFF'
                                        }}
                                    >
                                        Edit Approved Task
                                    </button>
                                </div>
                            )}

                            <div style={{
                                maxHeight: 'calc(100vh - 300px)',
                                overflowY: 'auto',
                                paddingRight: '4px'
                            }}>
                                {pendingChores.length === 0 ? (
                                    <div className="material-card" style={{
                                        padding: '32px 24px',
                                        textAlign: 'center',
                                        color: theme.textSecondary,
                                        fontSize: '0.875rem',
                                        background: theme.cardBg,
                                        border: `2px dashed ${theme.outline}`
                                    }}>
                                        No pending chores
                                    </div>
                                ) : (
                                    pendingChores.map(chore => {
                                        const player = players.find(p => p.id === chore.playerId);
                                        return (
                                            <div key={chore.id} className="material-card elevation-1" style={{
                                                marginBottom: '12px',
                                                padding: '16px',
                                                background: darkMode ? 'rgba(251, 191, 36, 0.15)' : '#FEF3C7',
                                                border: `2px solid ${darkMode ? '#fbbf24' : '#f59e0b'}`
                                            }}>
                                                <div style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px',
                                                    marginBottom: '12px'
                                                }}>
                                                    <div style={{ fontSize: '1.5rem' }}>{chore.icon}</div>
                                                    <div style={{ flex: 1 }}>
                                                        <div className="text-wrap" style={{
                                                            fontSize: '1rem',
                                                            fontWeight: '500',
                                                            marginBottom: '4px',
                                                            color: darkMode ? '#fbbf24' : '#78350f'
                                                        }}>
                                                            {chore.choreName}
                                                        </div>
                                                        <div style={{
                                                            fontSize: '0.875rem',
                                                            color: darkMode ? '#fbbf24' : '#92400e'
                                                        }}>
                                                            {player?.name} â€¢ {chore.points} pts
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {showApproval === chore.id ? (
                                                    <div>
                                                        <input
                                                            type="password"
                                                            placeholder="Admin code"
                                                            value={approvalCode}
                                                            onChange={(e) => setApprovalCode(e.target.value)}
                                                            className="material-input"
                                                            style={{
                                                                marginBottom: '12px',
                                                                background: theme.cardBg,
                                                                borderColor: theme.outline,
                                                                color: theme.cardText
                                                            }}
                                                            onKeyPress={(e) => {
                                                                if (e.key === 'Enter') {
                                                                    approveChore(chore.id, approvalCode);
                                                                }
                                                            }}
                                                        />
                                                        <div style={{ display: 'flex', gap: '8px' }}>
                                                            <button
                                                                className="material-button ripple"
                                                                onClick={() => approveChore(chore.id, approvalCode)}
                                                                style={{
                                                                    flex: 1,
                                                                    background: theme.success,
                                                                    color: '#FFFFFF'
                                                                }}
                                                            >
                                                                Approve
                                                            </button>
                                                            <button
                                                                className="material-button ripple"
                                                                onClick={() => {
                                                                    if (approvalCode === APPROVAL_CODE) {
                                                                        rejectChore(chore.id);
                                                                    } else {
                                                                        haptic('error');
                                                                        alert('âŒ Invalid admin code');
                                                                    }
                                                                }}
                                                                style={{
                                                                    flex: 1,
                                                                    background: theme.error,
                                                                    color: '#FFFFFF'
                                                                }}
                                                            >
                                                                Reject
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <button
                                                        className="material-button ripple"
                                                        onClick={() => setShowApproval(chore.id)}
                                                        style={{
                                                            width: '100%',
                                                            background: theme.primary,
                                                            color: theme.onPrimary
                                                        }}
                                                    >
                                                        Review
                                                    </button>
                                                )}
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>

                        {/* Custom Task */}
                        <div>
                            <div style={{
                                fontSize: '0.6875rem',
                                fontWeight: '500',
                                marginBottom: '16px',
                                textTransform: 'uppercase',
                                letterSpacing: '1px',
                                color: theme.textSecondary,
                                paddingLeft: '8px'
                            }}>
                                Custom Task
                            </div>
                            <div className="material-card elevation-1 player-bid-glow" style={{
                                padding: '16px',
                                background: theme.cardBg,
                                marginBottom: '16px'
                            }}>
                                <input
                                    type="text"
                                    placeholder="Task name"
                                    value={customTaskName}
                                    onChange={(e) => setCustomTaskName(e.target.value)}
                                    maxLength={100}
                                    className="material-input"
                                    style={{
                                        marginBottom: '12px',
                                        background: theme.surface,
                                        borderColor: theme.outline,
                                        color: theme.text
                                    }}
                                />
                                <input
                                    type="number"
                                    placeholder="Points"
                                    value={customTaskPoints}
                                    onChange={(e) => {
                                        const value = parseInt(e.target.value) || 0;
                                        setCustomTaskPoints(Math.max(1, Math.min(10000, value)));
                                    }}
                                    min="1"
                                    max="10000"
                                    step="25"
                                    className="material-input"
                                    style={{
                                        marginBottom: '12px',
                                        background: theme.surface,
                                        borderColor: theme.outline,
                                        color: theme.text
                                    }}
                                />
                                <input
                                    type="date"
                                    placeholder="Due date (optional)"
                                    value={customTaskDueDate}
                                    onChange={(e) => setCustomTaskDueDate(e.target.value)}
                                    className="material-input"
                                    style={{
                                        marginBottom: '16px',
                                        background: theme.surface,
                                        borderColor: theme.outline,
                                        color: theme.text
                                    }}
                                />

                                {/* Player Selection */}
                                <div style={{
                                    marginBottom: '12px'
                                }}>
                                    <div style={{
                                        fontSize: '0.875rem',
                                        fontWeight: '500',
                                        marginBottom: '8px',
                                        color: theme.cardText
                                    }}>
                                        Select Players:
                                    </div>
                                    <div style={{
                                        display: 'flex',
                                        flexWrap: 'wrap',
                                        gap: '8px'
                                    }}>
                                        {/* All button */}
                                        <button
                                            type="button"
                                            onClick={() => toggleCustomTaskPlayer('all')}
                                            className="ripple"
                                            style={{
                                                padding: '10px 16px',
                                                borderRadius: '12px',
                                                border: selectedCustomTaskPlayers.includes('all')
                                                    ? '2px solid #4CAF50'
                                                    : `2px solid ${theme.outline}`,
                                                background: selectedCustomTaskPlayers.includes('all')
                                                    ? 'rgba(76, 175, 80, 0.15)'
                                                    : theme.surface,
                                                color: selectedCustomTaskPlayers.includes('all')
                                                    ? '#4CAF50'
                                                    : theme.cardText,
                                                fontSize: '0.875rem',
                                                fontWeight: '600',
                                                cursor: 'pointer',
                                                transition: 'all 0.2s'
                                            }}
                                        >
                                            ðŸ‘¥ All
                                        </button>

                                        {/* Individual player buttons */}
                                        {(players || []).map(player => (
                                            <button
                                                key={player.id}
                                                type="button"
                                                onClick={() => toggleCustomTaskPlayer(player.id)}
                                                disabled={selectedCustomTaskPlayers.includes('all')}
                                                className="ripple"
                                                style={{
                                                    padding: '10px',
                                                    borderRadius: '12px',
                                                    border: selectedCustomTaskPlayers.includes(player.id)
                                                        ? '2px solid #4CAF50'
                                                        : `2px solid ${theme.outline}`,
                                                    background: selectedCustomTaskPlayers.includes(player.id)
                                                        ? 'rgba(76, 175, 80, 0.15)'
                                                        : theme.surface,
                                                    fontSize: '1.5rem',
                                                    cursor: selectedCustomTaskPlayers.includes('all') ? 'not-allowed' : 'pointer',
                                                    opacity: selectedCustomTaskPlayers.includes('all') ? 0.5 : 1,
                                                    transition: 'all 0.2s',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '6px'
                                                }}
                                            >
                                                {player.avatar}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <button
                                    className="material-button ripple"
                                    onClick={submitDashboardCustomTask}
                                    disabled={!customTaskName.trim() || !customTaskPoints || customTaskPoints <= 0 || selectedCustomTaskPlayers.length === 0}
                                    style={{
                                        width: '100%',
                                        background: (!customTaskName.trim() || !customTaskPoints || customTaskPoints <= 0 || selectedCustomTaskPlayers.length === 0)
                                            ? theme.outline
                                            : '#4CAF50',
                                        color: '#FFFFFF',
                                        opacity: (!customTaskName.trim() || !customTaskPoints || customTaskPoints <= 0 || selectedCustomTaskPlayers.length === 0) ? 0.5 : 1,
                                        cursor: (!customTaskName.trim() || !customTaskPoints || customTaskPoints <= 0 || selectedCustomTaskPlayers.length === 0) ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    Create Custom Task
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(FamilyChores));
    </script>
</body>
</html>
